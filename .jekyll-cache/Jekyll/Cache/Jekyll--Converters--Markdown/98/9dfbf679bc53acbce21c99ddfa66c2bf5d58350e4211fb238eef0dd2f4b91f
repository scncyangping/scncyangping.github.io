I"Ë!<h4 id="gitlabgitlab-ci-æœåŠ¡å™¨æ­å»º">gitlabã€gitlab-ci æœåŠ¡å™¨æ­å»º</h4>

<p>ç•¥</p>

<h4 id="cicd">CI/CD</h4>

<ol>
  <li>æ³¨å†Œrunner
    <blockquote>
      <p>suudo gitlab-ci-multi-runner register</p>
    </blockquote>
  </li>
</ol>

<blockquote>
  <p>æŒ‰è¦æ±‚è¾“å…¥gitlabæœåŠ¡å™¨çš„åœ°å€ã€tagsç­‰ä¿¡æ¯</p>
</blockquote>

<ol>
  <li>å¢åŠ .gitlab-ci.ymlæ–‡ä»¶</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
stages:
    - style
    - test
    - deploy
pep8:
    stage: style
    script:
        - pip install tox
        - tox -e pep8
    tags:
        - python2.7 # gitlab-ciæœåŠ¡å™¨ä¸Šåˆ›å»ºrunneræŒ‡å®šçš„tags

unittest-python27:
    stage: test
    script:
        - pip install tox
        - tox -e py27
    tags:
        - python2.7

# è‡ªåŠ¨éƒ¨ç½² (éƒ¨ç½²åˆ°ciæœåŠ¡å™¨)
docker-deploy:
    stage: deploy
    script:
        - docker build -t flask-demo . # ä»å½“å‰ç›®å½•æ‰¾åˆ°Dockerfileæ–‡ä»¶buildä¸€ä¸ªimage
        - docker run -d -p 5000:5000 flask-demo

    tages:
        - demo # é€‰æ‹©ä¸€ä¸ªshellç±»å‹çš„runner

    only: # åªæœ‰masteråˆ†æ”¯ä¿®æ”¹äº†æ‰ä¼šéƒ¨ç½²
        - master

docker-image-release:
    state: release
    script:
        - docker build -t registry.com/flask-demo:$CI_COMMIT_TAG .
        - docker push registry.com/flask-demo:$CI_COMMIT_TAG
        tags:
          - demo
        only:
          - tags

</code></pre></div></div>

<p>è‹¥æƒ³å®ç°è‡ªåŠ¨éƒ¨ç½²</p>

<ul>
  <li>
    <p>éœ€è¦æœ‰gitlabæœåŠ¡å™¨</p>
  </li>
  <li>éœ€è¦æœ‰gitlab-ciæœåŠ¡å™¨
    <ol>
      <li>æ­¤æœåŠ¡å™¨èƒ½å¤Ÿpingé€šdocker-registryæœåŠ¡å™¨</li>
      <li>éœ€è¦é…ç½®
        <blockquote>
          <p>/etc/docker/daemon.json
     &gt;æ·»åŠ {â€œinsecure-registriesâ€:{â€œip:ç«¯å£â€}}
         &gt; service docker restart</p>
        </blockquote>
      </li>
    </ol>
  </li>
  <li>éœ€è¦æœ‰docker-registryæœåŠ¡å™¨
    <blockquote>
      <p>gitlab-ci é€‰æ‹©shellç¯å¢ƒæ—¶,å¯ä»¥å°†æ‰“åŒ…çš„é•œåƒæäº¤åˆ°è‡ªå·±çš„dockerä»“åº“å†…ï¼Œåç»­å…¶ä»–èŠ‚ç‚¹å¯ä»¥æ‰‹åŠ¨æ›´æ–°</p>
    </blockquote>
  </li>
  <li>å¹¶ä¸”èƒ½å¤Ÿäº’é€š</li>
</ul>

<p>gitlab-ci çš„ç¼ºç‚¹æ˜¯è¿‡äºè‡ƒè‚¿,åªæœ‰éƒ¨ç½²äº†gitlab-ci runnerçš„èŠ‚ç‚¹æ‰èƒ½å»éƒ¨ç½²æ›´æ–°é¡¹ç›®ï¼Œå®‰è£…ä¸æ˜¯å¾ˆæ–¹ä¾¿</p>

<p>ç”±æ­¤å¯ä½¿ç”¨drone + gitlab ã€‚ä¼˜ç‚¹æ˜¯droneçš„serverå’Œclienéƒ½æ˜¯é‡‡ç”¨å®¹å™¨çš„æ–¹å¼éƒ¨ç½²çš„ï¼Œæ¯”è¾ƒæ–¹ä¾¿</p>

<h4 id="æ­å»ºdrone-çš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯">æ­å»ºdrone çš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯</h4>

<p>æ­å»ºdrone</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: '2'
services:
    drone-server:
        image: drone/drone:0.8

        ports:
            - 8000:8000
            - 9000
        volumes:
            - /home/data1/drone/drone-data:/var/lib/drone/
        restart: always
        environment:
            - DRONE_OPEN=true
            - DRONE_GITLAB=true
            - DRONE_GITLAB_CLIENT=3b026a57ef85bd05181a670ad32ded6b0d58e711e81c79864fd4801569e1c580 # è¿™ä¸ªåœ¨Gitlab UserSettings/Application ä¸­ç”Ÿæˆ
            - DRONE_GITLAB_SECRET=2bb590a29eb0de0ad345811da5253527d33c2c166ecf8bff17480396c8e7dff5  # è¿™ä¸ªåœ¨Gitlab UserSettings/Application ä¸­ç”Ÿæˆ
            - DRONE_GITLAB_URL=http://gitlab.dev # gitlabåœ°å€
            - DRONE_HOST=http://drone.dev # droneåœ°å€
            - DRONE_SECRET=123456

    drone-agent: # å¯ä¸serveråˆ†å¼€éƒ¨ç½²
        image: drone/agent:0.8

        restart: always
        depends_on:
            - drone-server
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
        environment:
            - DRONE_SERVER=drone-server:9000
            - DRONE_SECRET=123456
</code></pre></div></div>

<p>ç„¶ååœ¨gitlabé¡¹ç›®ç›®å½•ä¸­æ·»åŠ  drone.ymlæ–‡ä»¶,åˆ™ä¼šè‡ªåŠ¨è¿›è¡Œå…¶ä»–æ“ä½œ</p>

<p>test</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clone: # è®¾ç½®å…‹éš†åœ°å€ï¼Œä¸è®¾ç½®é»˜è®¤ä¸ºæœ¬åœ°
  git:
    image: plugins/git
    recursive: true # æ˜¯å¦é€’å½’æŸ¥æ‰¾
    skip_verify: true # è·³è¿‡httpsæ£€æµ‹
    submodule_override: # æŒ‡å®šé¡¹ç›®url æœ¬åœ°ç¯å¢ƒå¯ç”¨
      helloworld: http://192.168.0.87/demo/helloworld.git

pipeline:
  build:
    image: golang
    commands:
      # - go get
      - go build
      - go test

</code></pre></div></div>

<p>7moor</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>workspace: # æŒ‡å®špipelineçš„å·¥ä½œç›®å½•,ç›¸å¯¹äºé•œåƒæ¥è¯´
  base: /nodejs
  path: src/wcj-server
pipeline:


#  build:
#    image: registry.7moor.com/base/node:8.11
#    commands:
#      - tsc
  publish:
    image: plugins/docker
    dockerfile: Dockerfile
    username: 7m_docker
    password: wjU6k4iuuT
    repo: registry.7moor.com/wyx/wcj-server # ä»“åº“ä¸‹é¡¹ç›®çš„åç§°
    registry: registry.7moor.com # è‡ªå»ºdockerä»“åº“åœ°å€
    tags: "${DRONE_BRANCH}"
    when:
      branch: master
      event: [push, pull_request]
  deploy:
      image: appleboy/drone-ssh
      host: 123.206.78.95
      username: dockerPull
      password: YjVjNjEzNTQzMzg0ZDc3MGI3Zjc3
      port: 65022
      command_timeout: 600
      script:
        - sudo docker login -u 7m_docker -p wjU6k4iuuT open-registry.7moor.com
        - sudo docker pull open-registry.7moor.com/wyx/wcj-server:${DRONE_BRANCH}
        - sudo docker stop wcj-server
        - sudo docker rm wcj-server
        - sudo docker run -d  -p 3000:3000 -v /opt/wyx/wcj-server/logs:/workspace/logs -v /tmp/app:/tmp/app  -v /opt/wyx/wcj-server/conf:/workspace/conf --name wcj-server open-registry.7moor.com/wyx/wcj-server:${DRONE_BRANCH}

</code></pre></div></div>

<p>åŸºæœ¬æµç¨‹</p>

<p>é¡¹ç›®æµç¨‹ä¸ºï¼š</p>

<ul>
  <li>git push æäº¤ä»£ç åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿï¼ˆGitHubã€GitLabã€Gogs ç­‰ï¼‰</li>
  <li>ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿé€šè¿‡ webhook è§¦å‘ Drone çš„ pipeline</li>
  <li>Drone æ‰§è¡Œ pipelineï¼Œbuild æ„å»ºé¡¹ç›®</li>
  <li>æ„å»º Docker é•œåƒï¼ˆéœ€è¦ Dockerfile æ–‡ä»¶ï¼‰</li>
  <li>å°†é•œåƒ push åˆ° registryï¼ˆHarbor ç­‰ï¼‰</li>
</ul>

<h4 id="droneyml-æ–‡ä»¶åŸºæœ¬æ„ˆå‘">drone.yml æ–‡ä»¶åŸºæœ¬æ„ˆå‘</h4>
<p>https://blog.csdn.net/kikajack/article/details/80503786#%E5%8C%85%E5%90%AB%E8%B7%B3%E8%BF%87%E5%88%86%E6%94%AF-branches</p>

<ul>
  <li>branches
    <ol>
      <li>ä½¿ç”¨brancheså¯ä»¥è·³è¿‡æˆ–è€…æŒ‡å®šæŸäº›åˆ†æ”¯è¿›è¡Œpipline
        <blockquote>

          <p>```
  è·³è¿‡
  branches:
 exclude: [ develop, feature/* ]</p>
        </blockquote>
      </li>
    </ol>

    <p>åŒ…å«</p>

    <p>branches:
       include: [ master, feature/* ]</p>

    <p>åŒ¹é…
  branches: [ master, develop ]
  ```</p>
  </li>
  <li>pipelines
    <blockquote>
      <p>pipelines å®šä¹‰äº†å·¥ä½œæµï¼ˆæˆ–å«æµæ°´çº¿ï¼‰ï¼ŒåŒ…å«ä»£ç æ„å»ºï¼Œä»£ç æµ‹è¯•å’Œä»£ç éƒ¨ç½²ç­‰ä¸€ç³»åˆ—æ­¥éª¤ã€‚å·¥ä½œæµæ ¹æ®å„ä¸ªæ­¥éª¤çš„å®šä¹‰ä½ç½®æŒ‰é¡ºåºæ‰§è¡Œã€‚å¦‚æœä¸€ä¸ªæ­¥éª¤è¿”å›äº†é 0 çš„é€€å‡ºä»£ç ï¼Œå·¥ä½œæµå°†ç«‹å³åœæ­¢å¹¶è¿”å›ä¸€ä¸ªé”™è¯¯çŠ¶æ€ã€‚</p>
    </blockquote>
  </li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>å®šä¹‰ä¸¤ä¸ªå·¥ä½œæµ

pipeline:
  backend:
    image: golang
    commands: # è¿™äº›å‘½ä»¤ä¼šåœ¨dockeråˆ›å»ºæ—¶æ‰§è¡Œç±»ä¼¼entrypoint
      - go build
      - go test
  frontend:
    image: node
    commands:
      - npm install
      - npm run test
      - npm run build
</code></pre></div></div>

<ul>
  <li>æ¡ä»¶æ‰§è¡Œ when
  ```
  pipeline:
slack:
  image: plugins/slack
  channel: dev</li>
  <li>when:</li>
  <li>branch: master
    ```</li>
</ul>

<h4 id="drone-æŠ¥é”™">drone æŠ¥é”™</h4>

<ul>
  <li>å¦‚æœæ˜¯æœ¬åœ°æ­å»ºæœåŠ¡å™¨éœ€è¦ç”¨ç®¡ç†å‘˜ç™»é™†gitlabæœåŠ¡å™¨</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> gitlab 10.6 ç‰ˆæœ¬ä»¥åä¸ºäº†å®‰å…¨ï¼Œä¸å…è®¸å‘æœ¬åœ°ç½‘ç»œå‘é€webhookè¯·æ±‚ï¼Œå¦‚æœæƒ³å‘æœ¬åœ°ç½‘ç»œå‘é€webhookè¯·æ±‚ï¼Œåˆ™éœ€è¦ä½¿ç”¨ç®¡ç†å‘˜å¸å·ç™»å½•ï¼Œé»˜è®¤ç®¡ç†å‘˜å¸å·æ˜¯admin@example.comï¼Œå¯†ç å°±æ˜¯ä½ gitlabæ­å»ºå¥½ä¹‹åç¬¬ä¸€æ¬¡è¾“å…¥çš„å¯†ç ï¼Œç™»å½•ä¹‹åï¼ŒÂ ç‚¹å‡»Configure Gitlab

å³å¯è¿›å…¥Admin areaï¼Œåœ¨Admin areaä¸­ï¼Œåœ¨settingsæ ‡ç­¾ä¸‹é¢ï¼Œæ‰¾åˆ°OutBound Requestï¼Œå‹¾é€‰ä¸ŠAllow requests to the local network from hooks and services ï¼Œä¿å­˜æ›´æ”¹å³å¯è§£å†³é—®é¢˜

</code></pre></div></div>

<h4 id="é‡è¦é”™è¯¯æç¤º">é‡è¦é”™è¯¯æç¤ºï¼ï¼ï¼ï¼</h4>

<p>è‹¥ä¿®æ”¹äº†gitlabåœ°å€,åˆ™ç›¸åº”çš„é…ç½®droneæœåŠ¡å™¨çš„é…ç½®æ–‡ä»¶ä¸­çš„volumeåœ°å€ä¹Ÿéœ€è¦æ”¹å˜ï¼Œå¦åˆ™ï¼Œgitæ‹‰å–ä»£ç çš„åœ°å€è¿˜æ˜¯ä»¥å‰çš„åœ°å€ï¼åˆ‡è®°åˆ‡è®°ï¼</p>

<h4 id="drone-server-clientåˆ†å¼€å®‰è£…">drone server clientåˆ†å¼€å®‰è£…</h4>

<p>https://mritd.me/2018/03/30/set-up-drone-ci/</p>
:ET