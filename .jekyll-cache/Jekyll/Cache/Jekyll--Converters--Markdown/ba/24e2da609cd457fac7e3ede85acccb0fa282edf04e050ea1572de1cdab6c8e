I"à=<h2 id="ä¼˜åŒ–ç­–ç•¥">ä¼˜åŒ–ç­–ç•¥</h2>
<p>ä»€ä¹ˆå¯¼è‡´HBaseæ€§èƒ½ä¸‹é™?</p>

<ul>
  <li>jvmå†…å­˜åˆ†é…å’ŒGCå›æ”¶ç­–ç•¥</li>
  <li>HBaseè¿è¡Œæœºåˆ¶ç›¸å…³çš„éƒ¨åˆ†é…ç½®ä¸åˆç†</li>
  <li>è¡¨æœºæ„è®¾è®¡åŠç”¨æˆ·ä½¿ç”¨æ–¹å¼ä¸åˆç†</li>
</ul>

<h5 id="hbaseå­˜å‚¨æ—¶è€—æ—¶æ“ä½œ">HBaseå­˜å‚¨æ—¶è€—æ—¶æ“ä½œ</h5>

<ol>
  <li>
    <p>HBaseå†™å…¥æ—¶å½“memstoreè¾¾åˆ°ä¸€å®šçš„å¤§å°ä¼šflushåˆ°ç£ç›˜
ä¿å­˜æˆHFile,å½“HFileå°æ–‡ä»¶å¤ªå¤šä¼šæ‰§è¡Œcompactæ“ä½œè¿›è¡Œåˆå¹¶(å½“æ¯ä¸€ä¸ªstoreåªåŒ…å«ä¸€ä¸ªHFileæ—¶,æŸ¥è¯¢æ•ˆç‡æœ€é«˜,é¿å…äº†å†…å­˜å¯»å€æ—¶é—´)</p>
  </li>
  <li>
    <p>å½“Regionçš„å¤§å°è¾¾åˆ°æŸä¸€ä¸ªé˜€å€¼ä¼šæ‰§è¡Œsplitæ“ä½œ</p>
  </li>
</ol>

<ul>
  <li>minor compaction: é€‰å–ä¸€äº›å°çš„ã€ç›¸é‚»çš„storeFileå°†ä»–ä»¬åˆå¹¶æˆä¸€ä¸ªæ›´å¤§çš„StoreFile
    <ol>
      <li>MemStoreè¢«flushåˆ°ç£ç›˜</li>
      <li>ç”¨æˆ·æ‰§è¡Œshellå‘½ä»¤compact major_compactæˆ–è€…è°ƒç”¨ç›¸åº”çš„api</li>
      <li>HBaseåå°ç°åœºå‘¨æœŸæ€§è§¦å‘æ£€æŸ¥</li>
    </ol>
  </li>
  <li>major compaction: å°†æ‰€æœ‰çš„StoreFileåˆå¹¶æˆä¸€ä¸ªStoreFile,æ¸…ç†æ— æ„ä¹‰æ•°æ®: è¢«åˆ é™¤çš„æ•°æ®ã€TTLè¿‡æœŸæ•°æ®ã€ç‰ˆæœ¬å·è¶…è¿‡è®¾å®šç‰ˆæœ¬å·çš„æ•°æ®</li>
  <li>split: å½“ä¸€ä¸ªregionè¾¾åˆ°ä¸€å®šçš„å¤§å°å°±ä¼šè‡ªåŠ¨splitæˆä¸¤ä¸ªregion</li>
</ul>

<h3 id="ä¼˜åŒ–ç­–ç•¥ç±»åˆ«">ä¼˜åŒ–ç­–ç•¥ç±»åˆ«</h3>

<ul>
  <li>å¸¸è§æœåŠ¡ç«¯é…ç½®ä¼˜åŒ–</li>
  <li>å¸¸ç”¨ä¼˜åŒ–ç­–ç•¥(ä»¥å®é™…éœ€æ±‚ã€æ¯”å¦‚å»ºè¡¨ç­‰)</li>
  <li>HBaseè¯»/å†™æ€§èƒ½ä¼˜åŒ–</li>
</ul>

<h4 id="æœåŠ¡ç«¯ä¼˜åŒ–">æœåŠ¡ç«¯ä¼˜åŒ–</h4>

<ul>
  <li>JVMè®¾ç½®ä¸GCè®¾ç½®</li>
  <li>hbase-site.xmléƒ¨åˆ†å±æ€§è®¾ç½®</li>
</ul>

<table>
  <thead>
    <tr>
      <th>HBase properties</th>
      <th>ç®€ä»‹</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>hbase.regionserver.handler.count</td>
      <td>rpcè¯·æ±‚çš„çº¿ç¨‹æ•°é‡,é»˜è®¤æ˜¯10</td>
    </tr>
    <tr>
      <td>hbase.hregion.max.filesize</td>
      <td>å½“regionçš„å¤§å°å¤§äºè®¾å®šå€¼å,hbaseä¼šå¼€å§‹split,é»˜è®¤æ˜¯10G</td>
    </tr>
    <tr>
      <td>hbase.hregion.majorcompaction</td>
      <td>major compactionçš„æ‰§è¡Œå‘¨æœŸ,é»˜è®¤æ˜¯ä¸€å¤©,å»ºè®®å…³é—­,æ‰‹åŠ¨æ‰§è¡Œ</td>
    </tr>
    <tr>
      <td>hbase.hstore.compation.min</td>
      <td>ä¸€ä¸ªstoreé‡Œçš„storefileæ€»æ•°è¶…è¿‡è¯¥å€¼,ä¼šè§¦å‘åˆå¹¶æ“ä½œ</td>
    </tr>
    <tr>
      <td>hbase.hstore.compaction.max</td>
      <td>ä¸€æ¬¡æœ€å¤šåˆå¹¶å¤šå°‘storefile,æ ¹æ®å†…å­˜è®¾ç½®,é¿å…æ–‡ä»¶è¿‡å¤šé€ æˆå†…å­˜æº¢å‡º</td>
    </tr>
    <tr>
      <td>hbase.hstore.blockingStoreFiles</td>
      <td>ä¸€ä¸ª regionä¸­çš„Store(Coulmn Family)å†…æœ‰è¶…è¿‡xxä¸ªstorefileæ—¶,åˆ™blockæ‰€æœ‰çš„å†™è¯·æ±‚è¿›è¡Œcompaction</td>
    </tr>
    <tr>
      <td>hfile.block.cache.size</td>
      <td>regionserverçš„block cacheçš„å†…å­˜å¤§å°é™åˆ¶,æ ¹æ®å®é™…å»è®¾ç½®</td>
    </tr>
    <tr>
      <td>hbase.hregion.memstore.flush.size</td>
      <td>memstoreè¶…è¿‡è¯¥å€¼å°†è¢«flush</td>
    </tr>
    <tr>
      <td>hbase.hregion.memstore.block.multiplier</td>
      <td>å¦‚æœmemstoreçš„å†…å­˜è¶…è¿‡flush.size * multiplier,ä¼šé˜»å¡è¯¥memstoreçš„å†™æ“ä½œ</td>
    </tr>
  </tbody>
</table>

<h4 id="å¸¸ç”¨çš„ä¼˜åŒ–ç­–ç•¥">å¸¸ç”¨çš„ä¼˜åŒ–ç­–ç•¥</h4>

<p>ä¸»è¦åˆ†å››ä¸ªéƒ¨åˆ†</p>

<ul>
  <li>é¢„å…ˆåˆ†åŒº</li>
  <li>RowKeyä¼˜åŒ–</li>
  <li>Columnä¼˜åŒ–</li>
  <li>Schemaä¼˜åŒ–</li>
</ul>

<h5 id="é¢„å…ˆåˆ†åŒº">é¢„å…ˆåˆ†åŒº</h5>

<p>HBaseåœ¨åˆ›å»ºè¡¨çš„æ—¶å€™,ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªRegionåˆ†åŒº,æ•°æ®å†™å…¥çš„æ—¶å€™,ä¼šç›´æ¥å†™å…¥,å½“æ•°æ®é‡è¾¾åˆ°ä¸€å®šå¤§å°çš„æ—¶å€™,ä¼šæ‰§è¡Œsplitæ“ä½œ,è¿›è¡Œåˆ†åŒº,splitåˆ†åŒºéå¸¸è€—æ—¶ã€‚</p>

<p>è§£å†³:</p>

<p>åˆ›å»ºHBaseè¡¨çš„æ—¶å€™é¢„å…ˆåˆ›å»ºä¸€äº›ç©ºçš„Region,å¯ä»¥å°†é¢‘ç¹è®¿é—®çš„æ•°æ®æ”¾åœ¨ä¸€ä¸ªæˆ–å¤šä¸ªRegionä¸­,å¦å¤–çš„æ”¾åœ¨å¦å¤–çš„Regionä¸­,é¿å…æ•°æ®å€¾æ–œçš„é—®é¢˜</p>

<h5 id="rowkeyä¼˜åŒ–">RowKeyä¼˜åŒ–</h5>

<ul>
  <li>åˆ©ç”¨HBaseé»˜è®¤æ’åºçš„ç‰¹ç‚¹,å°†ä¸€èµ·è®¿é—®çš„æ•°æ®æ”¾åˆ°ä¸€èµ·</li>
  <li>é˜²æ­¢çƒ­ç‚¹é—®é¢˜(åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­,å¤§é‡clienté›†ä¸­è®¿é—®æŸä¸€ä¸ªèŠ‚ç‚¹),é¿å…ä½¿ç”¨æ—¶åºæˆ–è€…å•è°ƒé€’å¢é€’å‡ç­‰,ä¸€èˆ¬é€šè¿‡åŠ ç›æ–¹å¼,åœ¨RowKeyå‰é¢æ·»åŠ éšæœºæ•°</li>
</ul>

<h5 id="column-ä¼˜åŒ–">Column ä¼˜åŒ–</h5>

<ul>
  <li>åˆ—æ—çš„åç§°å’Œåˆ—çš„æè¿°å‘½åå°½é‡ç®€çŸ­</li>
  <li>åŒä¸€å¼ è¡¨ä¸­ColumnFmailyçš„æ•°é‡ä¸è¦æ“ä½œ3ä¸ª</li>
</ul>

<h5 id="schema-ä¼˜åŒ–">Schema ä¼˜åŒ–</h5>

<ul>
  <li>å®½è¡¨: ä¸€ç§â€åˆ—å¤šè¡Œå°‘â€çš„è®¾è®¡</li>
  <li>é«˜è¡¨: ä¸€ç§â€åˆ—å°‘è¡Œå¤šâ€è®¾è®¡</li>
</ul>

<p>æŸ¥è¯¢æ•ˆç‡ : é«˜è¡¨å¤§äºå®½è¡¨,æŸ¥è¯¢çš„æ¡ä»¶å¯ä»¥é˜²æ­¢RowKeyä¸­,ç¼“å­˜çš„è¯,å¯ä»¥ç¼“å­˜æ›´å¤šçš„è¡Œ
æºæ•°æ®çš„å¼€é”€ : è¡Œæ¯”è¾ƒå¤š,RowKeyæ¯”è¾ƒå¤š,Regionå°±ä¹Ÿä¼šæ¯”è¾ƒå¤š
äº‹ç‰©æ€§ : å®½è¡¨å¤§äºé«˜è¡¨,å› ä¸ºHBaseæ˜¯å•è¡Œäº‹ç‰©</p>

<h4 id="è¯»å†™æ€§èƒ½çš„ä¼˜åŒ–ç­–ç•¥">è¯»å†™æ€§èƒ½çš„ä¼˜åŒ–ç­–ç•¥</h4>

<h5 id="å†™æµç¨‹">å†™æµç¨‹</h5>

<ul>
  <li>åŒæ­¥æ‰¹é‡æäº¤ or å¼‚æ­¥æ‰¹é‡æäº¤</li>
  <li>WALä¼˜åŒ–,æ˜¯å¦å¿…é¡»,æŒä¹…åŒ–ç­‰çº§,å¯¹äºæ•°æ®ä¸¢å¤±æ˜¯å¦èƒ½å¿å—,èƒ½å°±å…³é—­WALã€‚ä¼šå½±å“æ•°æ®çš„å®Œæ•´æ€§</li>
</ul>

<h5 id="è¯»æ€§èƒ½">è¯»æ€§èƒ½</h5>

<ul>
  <li>å®¢æˆ·ç«¯ : Scanç¼“å­˜è®¾ç½®,æ‰¹é‡è·å–(ä¸è¦åŒæ—¶è¯·æ±‚å¤ªå¤š,å®¢æˆ·ç«¯å¯åˆ†æ‰¹æ¬¡è¯·æ±‚)é¿å…æœåŠ¡ç«¯å¸¦å®½è¿‡å¤§,æœ¬åœ°å†…å­˜æº¢å‡ºç­‰é—®é¢˜</li>
  <li>æœåŠ¡ç«¯ : BlockCacheé…ç½®æ˜¯å¦åˆç†,HFileæ˜¯å¦è¿‡å¤š,è¿‡å¤šæ˜¯å¦éœ€è¦æ‰§è¡Œcompactå‘½ä»¤è¿›è¡Œåˆå¹¶</li>
  <li>è¡¨ç»“æ„è®¾è®¡</li>
</ul>

<h3 id="hbase-coprecessor">HBase Coprecessor</h3>

<ul>
  <li>HBaseåå¤„ç†å™¨å—BigTableåå¤„ç†å™¨çš„å¯å‘,ä¸ºç”¨æˆ·æä¾›ç±»åº“å’Œè¿è¡Œæ—¶ç¯å¢ƒ,ä½¿å¾—ä»£ç èƒ½å¤Ÿåœ¨HBase RegionServerå’ŒMasterä¸Šå¤„ç†</li>
  <li>åˆ†ä¸ºç³»ç»Ÿåå¤„ç†å™¨å’Œè¡¨åå¤„ç†å™¨
    <ol>
      <li>ç³»ç»Ÿåå¤„ç†å™¨: å…¨å±€åŠ è½½åˆ°RegionServeræ‰˜ç®¡çš„æ‰€æœ‰è¡¨å’ŒRegionä¸Š</li>
      <li>è¡¨åå¤„ç†å™¨: ç”¨æˆ·å¯ä»¥æŒ‡å®šä¸€å¼ è¡¨ä½¿ç”¨åå¤„ç†å™¨</li>
    </ol>
  </li>
  <li>Observer and Endpoint
    <ol>
      <li>Observer: è§‚å¯Ÿè€…,ç±»ä¼¼ä¸è§¦å‘å™¨
        <ol>
          <li>RegionObserver: æä¾›å®¢æˆ·ç«¯çš„æ•°æ®æ“çºµäº‹ä»¶é’©å­: Getã€Putã€Deleteã€Scanç­‰</li>
          <li>MasterObserver: æä¾›DDLç±»å‹çš„æ“ä½œé’©å­ã€‚å¦‚åˆ›å»ºã€åˆ é™¤ã€ä¿®æ”¹æ•°æ®åº“è¡¨ç­‰</li>
          <li>WALObserver: æä¾›WALç›¸å…³æ“ä½œé’©å­</li>
        </ol>
      </li>
      <li>Endpoint: ç»ˆç«¯,ç±»ä¼¼å­˜å‚¨è¿‡ç¨‹</li>
    </ol>
  </li>
</ul>

<h4 id="observer-åº”ç”¨åœºæ™¯">Observer åº”ç”¨åœºæ™¯</h4>

<ul>
  <li>å®‰å…¨æ€§: ä¾‹å¦‚æ‰§è¡ŒGetæˆ–Putæ“ä½œå‰,ç—›æ®´preGetæˆ–prePutæ–¹æ³•æ£€æŸ¥æ˜¯å¦å…è®¸è¯¥æ“ä½œ</li>
  <li>å¼•ç”¨å®Œæ•´æ€§çº¦æŸ: HBaseå¹¶ä¸æ”¯æŒå…³ç³»å‹æ•°æ®åº“ä¸­çš„å¼•ç”¨å®Œæ•´æ€§çº¦æŸæ¦‚å¿µ,å³é€šå¸¸æ‰€è¯´çš„å¤–é”®ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åå¤„ç†å™¨å¢å¼ºè¿™ç§çº¦æŸã€‚</li>
  <li>äºŒçº§ç´¢å¼•: å¯ä»¥ä½¿ç”¨åå¤„ç†å™¨æ¥ç»´æŒä¸€ä¸ªäºŒçº§ç´¢å¼•</li>
</ul>

<h4 id="endpoint">Endpoint</h4>

<ul>
  <li>Endpointæ˜¯åŠ¨æ€RPCæ’ä»¶çš„æ¥å£,å®ƒçš„å®ç°ä»£ç è¢«å®‰è£…åœ¨æœåŠ¡å™¨ç«¯,ä»è€Œèƒ½å¤Ÿé€šè¿‡HBase RPCå”¤é†’</li>
  <li>è°ƒç”¨æ¥å£,ä»–ä»¬çš„å®ç°ä»£ç ä¼šè¢«ç›®æ ‡RegionServerè¿œç¨‹æ‰§è¡Œ</li>
  <li>å…¸å‹çš„æ¡ˆä¾‹: ä¸€ä¸ªå¤§çš„Tableæœ‰å‡ ç™¾ä¸ªRegion,éœ€è¦è®¡ç®—æŸåˆ—çš„å¹³å‡å€¼æˆ–è€…æ€»å’Œ</li>
</ul>

<h3 id="å®æˆ˜">å®æˆ˜</h3>

<h4 id="observer">Observer</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import org.apache.hadoop.hbase.Cell;
import org.apache.hadoop.hbase.CellUtil;
import org.apache.hadoop.hbase.CoprocessorEnvironment;
import org.apache.hadoop.hbase.client.*;
import org.apache.hadoop.hbase.coprocessor.BaseRegionObserver;
import org.apache.hadoop.hbase.coprocessor.ObserverContext;
import org.apache.hadoop.hbase.coprocessor.RegionCoprocessorEnvironment;
import org.apache.hadoop.hbase.regionserver.wal.WALEdit;
import org.apache.hadoop.hbase.util.Bytes;
import org.apache.hadoop.hbase.util.CollectionUtils;

import java.io.IOException;
import java.util.Arrays;
import java.util.List;

/**
 * &lt;p&gt;
 *
 * &lt;/p&gt;
 *
 * @author guazi
 * Email guazi@uoko.com
 * created by 2019/07/22
 */
public class RegionServerTest extends BaseRegionObserver {

    private byte[] columnFamily = Bytes.toBytes("cf");

    private byte[] countCol = Bytes.toBytes("countCol");

    private byte[] unDeleteCol = Bytes.toBytes("unDeleteCol");

    private RegionCoprocessorEnvironment environment;

    // RegionServer æ‰“å¼€regionæ—¶æ‰§è¡Œ
    @Override
    public void start(CoprocessorEnvironment e) throws IOException {
        super.start(e);
    }
    // RegionServer å…³é—­regionæ—¶æ‰§è¡Œ
    @Override
    public void stop(CoprocessorEnvironment e) throws IOException {
        super.stop(e);
    }

    /**
     * 1. cf : countCol è¿›è¡Œç´¯åŠ æ“ä½œ æ¯æ¬¡æ’å…¥æ—¶,éƒ½è¦ä¸ä¹‹å‰çš„å€¼è¿›è¡Œç›¸åŠ 
     */
    @Override
    public void prePut(ObserverContext&lt;RegionCoprocessorEnvironment&gt; e, Put put, WALEdit edit, Durability durability) throws IOException {

        if (put.has(columnFamily,countCol)){
            // å¦‚æœå‘ç°æ–°æ’å…¥çš„åŒ…å«countColè¿™ä¸€åˆ—
            // è·å–old countCol value
            Result rs = e.getEnvironment().getRegion().get(
                    new Get(put.getRow())
            );

            int oldNum = 0;

            for (Cell cell:rs.rawCells()){
                if (CellUtil.matchingColumn(cell,columnFamily,countCol)){
                    oldNum = Integer.valueOf(Bytes.toString(CellUtil.cloneValue(cell)));
                }
            }

            // è·å–new countCol value
            List&lt;Cell&gt; cells = put.get(columnFamily,countCol);
            int newNum = 0;
            for (Cell cell : cells){
                if (CellUtil.matchingColumn(cell,columnFamily,countCol)){
                    newNum = Integer.valueOf(Bytes.toString(CellUtil.cloneValue(cell)));
                }
            }

            // sum AND update
            put.addColumn(columnFamily,countCol,Bytes.toBytes(
                    String.valueOf(oldNum + newNum)
            ));
        }
    }

    /**
     * 2. ä¸èƒ½ç›´æ¥åˆ é™¤unDeleteCol åˆ é™¤countColçš„æ—¶å€™å°†unDeleteColä¸€èµ·åˆ é™¤
     */
    @Override
    public void preDelete(ObserverContext&lt;RegionCoprocessorEnvironment&gt; e,
                          Delete delete, WALEdit edit, Durability durability) throws IOException {
        // åˆ¤æ–­æ˜¯å¦æ“ä½œcfåˆ—
        List&lt;Cell&gt; cells = delete.getFamilyCellMap().get(columnFamily);

        if (CollectionUtils.isEmpty(cells))return;

        boolean deleteFlag = false;

        for (Cell cell : cells) {
            byte[] qualifier = CellUtil.cloneQualifier(cell);

            if (Arrays.equals(qualifier, unDeleteCol)) {
                throw new IOException("can not delete unDel column");
            }
            if (Arrays.equals(qualifier, countCol)) {
                deleteFlag = true;
            }
        }

        if (deleteFlag){
            delete.addColumn(columnFamily,unDeleteCol);
        }
    }
}

</code></pre></div></div>

<h4 id="endpoint-1">Endpoint</h4>

<ol>
  <li>å®šä¹‰ç›¸åº”çš„protobufferæ¥å£</li>
  <li>ç”Ÿæˆç›¸å…³ä»£ç </li>
  <li>ç¼–å†™è‡ªå·±è¦å®ç°çš„ä¸šåŠ¡ä»£ç </li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class TestRowCountEndPoint extends hbaseEndPointTestService
                implements Coprocessor, CoprocessorService {

                @Override
                ...
}
</code></pre></div></div>

<h4 id="åŠ è½½">åŠ è½½</h4>

<p>å°†åå¤„ç†å™¨åŠ è½½åˆ°hbase</p>

<ul>
  <li>é…ç½®æ–‡ä»¶åŠ è½½: å³é€šè¿‡hbase-site.xmlæ–‡ä»¶é…ç½®åŠ è½½,ä¸€èˆ¬è¿™æ ·çš„åå¤„ç†å™¨æ˜¯ç³»ç»Ÿçº§åˆ«çš„</li>
  <li>shellåŠ è½½: å¯ä»¥é€šè¿‡alterå‘½ä»¤æ¥å¯¹è¡¨è¿›è¡Œschemaä¿®æ”¹æ¥åŠ è½½åå¤„ç†å™¨</li>
  <li>é€šè¿‡APIä»£ç åŠ è½½: å³é€šè¿‡APIçš„æ–¹å¼æ¥åŠ è½½åå¤„ç†å™¨</li>
</ul>

<p>1ã€3éƒ½éœ€è¦å°†ä»£ç jaråŒ…é˜²æ­¢hbaseçš„classpathå½“ä¸­</p>
<ol>
  <li>åªéœ€è¦ä¸Šä¼ åˆ°hbaseçš„é›†ç¾¤æ–‡ä»¶å°±è¡Œäº†</li>
</ol>

<h5 id="é…ç½®æ–‡ä»¶åŠ è½½">é…ç½®æ–‡ä»¶åŠ è½½</h5>

<p>value ä¸ºç±»åå…¨è·¯å¾„</p>

<table>
  <thead>
    <tr>
      <th>å±æ€§</th>
      <th>è¯´æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>hbase.coprocessor.region.clasees</td>
      <td>é…ç½®RegionObserverså’ŒEndpoints</td>
    </tr>
    <tr>
      <td>hbase.coprocessor.wal.classes</td>
      <td>é…ç½®WALObservers</td>
    </tr>
    <tr>
      <td>hbase.coprocessor.master.classes</td>
      <td>é…ç½®MasterObservers</td>
    </tr>
  </tbody>
</table>

<h5 id="shellåŠ è½½">shellåŠ è½½</h5>

<p>alter â€˜CoprocessorTestTableâ€™,â€™coprocessorâ€™=&gt;
â€˜hdfs://localhost:9000/path/coprocessor.jar|com.immoc.hbase.TestRegionObserver|1001|â€™</p>

<blockquote>
  <p>å‚æ•° 1. è·¯å¾„ 2. å…¨è·¯å¾„å 3. ä¼˜å…ˆçº§</p>
</blockquote>

<h4 id="hbase-å¤‡ä»½ä¸æ¢å¤">HBase å¤‡ä»½ä¸æ¢å¤</h4>

<ul>
  <li>CopyTable (åŸºäºMapReduce)</li>
  <li>Export/Import (åŸºäºMapReduce)</li>
  <li>Snapshot</li>
  <li>Replication (å¸¸ç”¨)</li>
</ul>

<h5 id="copytable">CopyTable</h5>

<ul>
  <li>æ”¯æŒæ—¶é—´åŒºé—´ã€rowåŒºé—´,æ”¹å˜è¡¨åç§°,æ”¹å˜åˆ—æ—åç§°,æŒ‡å®šæ˜¯å¦copyå·²ç»è¢«åˆ é™¤çš„æ•°æ®ç­‰åŠŸèƒ½</li>
  <li>CopyTableå·¥å…·é‡‡ç”¨scanæŸ¥è¯¢,å†™å…¥æ–°è¡¨æ—¶é‡‡ç”¨putå’Œdelete API,å…¨æ˜¯åŸºäºhbaseçš„client apiè¿›è¡Œè¯»å†™</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. åˆ›å»ºæ–°çš„è¡¨å¹¶æŒ‡å®šç›¸åº”åˆ—æ—
2. æ‰§è¡Œå‘½ä»¤è¿›è¡Œæ‹·è´

./hbase org.apache.hadoop.hbase.mapreduce.CopyTable --new.name=FileTableNew FileTable

</code></pre></div></div>

<h4 id="exportimport">Export/Import</h4>

<ul>
  <li>Exportå¯å¯¼å‡ºæ•°æ®åˆ°ç›®æ ‡é›†ç¾¤,ç„¶åå¯åœ¨ç›®æ ‡é›†ç¾¤Importå¯¼å…¥æ•°æ®,Exportæ”¯æŒæŒ‡å®šå¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´,å› æ­¤å¯ä»¥åšå¢é‡å¤‡ä»½</li>
  <li>Exportå¯¼å‡ºå·¥å…·ä¸CopyTableä¸€æ ·æ˜¯ä¾èµ–hbaseçš„scanè¯»å–æ•°æ®</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Export

./hbase org.apache.hadoop.hbase.mapreduce.Export {å¯¼å‡ºçš„è¡¨å} {å­˜å‚¨åœ¨hdfsçš„è·¯å¾„}

Import

./hbase org.apache.hadoop.hbase.mapreduce.Import {å¯¼å…¥çš„è¡¨å} {å­˜å‚¨åœ¨hdfsçš„è·¯å¾„}

</code></pre></div></div>

<h4 id="snapshot">Snapshot</h4>

<ul>
  <li>Snapshot(å¿«ç…§)ä½œç”¨äºè¡¨ä¸Šã€‚é€šè¿‡é…ç½®hbase-site.xmlå¼€å¯è¯¥åŠŸèƒ½</li>
  <li>å¯ä»¥å¿«é€Ÿçš„æ¢å¤è¡¨è‡³å¿«ç…§æŒ‡å®šçš„çŠ¶æ€ä»è€Œè¿…é€Ÿçš„ä¿®å¤æ•°æ®(ä¼šä¸¢å¤±å¿«ç…§ä¹‹åçš„æ•°æ®)</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;property&gt;
    &lt;name&gt;hbase.snapshot.enabled&lt;/name&gt;
    &lt;value&gt;true&lt;/value&gt;
&lt;/property&gt;
</code></pre></div></div>

<ul>
  <li>ä½¿ç”¨</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#åˆ›å»ºå¿«ç…§
snapshot 'myTable','myTableSnapshot-190731'
#å…‹éš†å¿«ç…§
clone_snapshot 'myTableSnapshot-190731','myNewTestTable'
#åˆ—å‡ºå¿«ç…§
list_snapshots
#åˆ é™¤å¿«ç…§
delete_snapshot 'myTableSnapshot-190731'
#æ¢å¤æ•°æ®
disable 'myTable'
restore_snapshot 'myTableSnapshot-190731'
</code></pre></div></div>

<h4 id="hbaseå®¹ç¾ç­–ç•¥">HBaseå®¹ç¾ç­–ç•¥</h4>

<ul>
  <li>å¯ä»¥é€šè¿‡replicationæœºåˆ¶å®ç°hbaseé›†ç¾¤çš„ä¸»ä»æ¨¡å¼</li>
  <li>replicationæ˜¯ä¾èµ–WALæ—¥å¿—è¿›è¡Œçš„åŒæ­¥(è‹¥æ²¡å†™WALæ—¥å¿—,replicationæ˜¯ä¸ç”Ÿæ•ˆçš„)</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hbase-site.xml

&lt;property&gt;
    &lt;name&gt;hbase.replication&lt;/name&gt;
    &lt;value&gt;true&lt;/value&gt;
&lt;/property&gt;
</code></pre></div></div>

<ul>
  <li>ä½¿ç”¨</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#åœ¨åŸé›†ç¾¤åŠç›®æ ‡é›†ç¾¤éƒ½åˆ›å»ºåŒåè¡¨
#æŒ‡å®šç›®æ ‡é›†ç¾¤zkåœ°å€å’Œè·¯å¾„

# æ‰§è¡Œå‘½ä»¤
add_peer '1',"zk01:2181:/hbase_backup"

#æ ‡æ³¨éœ€è¦å¤‡ä»½çš„åˆ—æ—ä¿¡æ¯åŠå¤‡ä»½çš„ç›®æ ‡åº“åœ°å€
# replication_scopeå€¼ä¸ºä¸Šé¢add_peeræŒ‡å®šçš„å€¼

alter 'replication_source_table',{NAME=&gt;'f1',REPLICATION_SCOPE=&gt;'1'}
</code></pre></div></div>
:ET