I"Óå<h4 id="åˆ›å»ºè¿›ç¨‹">åˆ›å»ºè¿›ç¨‹</h4>

<p>åœ¨Unixä¸­ï¼Œåˆ›å»ºâ¼€ä¸ªè¿›ç¨‹ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒâ½¤forkå®ç°ï¼ˆåŠå…¶â¼€äº›å˜ç§ï¼Œå¦‚vforkã€cloneï¼‰ã€‚åœ¨Goè¯­â¾”ä¸­ï¼ŒLinuxä¸‹åˆ›å»ºè¿›ç¨‹ä½¿â½¤çš„ç³»ç»Ÿè°ƒâ½¤æ˜¯cloneã€‚å¾ˆå¤šæ—¶å€™ï¼Œç³»ç»Ÿè°ƒâ½¤forkã€execveã€waitå’Œexitä¼šåœ¨â¼€èµ·å‡ºç°ã€‚æ­¤å¤„å…ˆç®€è¦ä»‹ç»è¿™4ä¸ªç³»ç»Ÿè°ƒâ½¤åŠå…¶å…¸å‹â½¤æ³•</p>

<ul>
  <li>fork: å…è®¸â¼€è¿›ç¨‹ï¼ˆâ½—è¿›ç¨‹ï¼‰åˆ›å»ºâ¼€æ–°è¿›ç¨‹ï¼ˆâ¼¦è¿›ç¨‹ï¼‰ã€‚å…·ä½“åšæ³•æ˜¯ï¼Œæ–°çš„â¼¦è¿›ç¨‹â¼è¿‘äºå¯¹â½—è¿›ç¨‹çš„ç¿»ç‰ˆï¼šâ¼¦è¿›ç¨‹è·å¾—â½—è¿›ç¨‹çš„æ ˆã€æ•°æ®æ®µã€å †å’Œæ‰§â¾â½‚æœ¬æ®µçš„æ‹·â»‰ã€‚å¯å°†æ­¤è§†ä¸ºæŠŠâ½—è¿›ç¨‹â¼€åˆ†ä¸ºâ¼†</li>
  <li>exit(status)ï¼šç»ˆâ½Œâ¼€è¿›ç¨‹ï¼Œå°†è¿›ç¨‹å â½¤çš„æ‰€æœ‰èµ„æºï¼ˆå†…å­˜ã€â½‚ä»¶æè¿°ç¬¦ç­‰ï¼‰å½’è¿˜å†…æ ¸ï¼Œäº¤å…¶è¿›â¾å†æ¬¡åˆ†é…ã€‚å‚æ•°statusä¸ºâ¼€æ•´å‹å˜é‡ï¼Œè¡¨ç¤ºè¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ã€‚â½—è¿›ç¨‹å¯ä½¿â½¤ç³»ç»Ÿè°ƒâ½¤wait()æ¥è·å–è¯¥çŠ¶æ€</li>
  <li>wait(&amp;status)â½¬çš„æœ‰â¼†ï¼šå…¶â¼€ï¼Œå¦‚æœè¿›ç¨‹å°šæœªè°ƒâ½¤exit()ç»ˆâ½Œï¼Œé‚£ä¹ˆwaitä¼šæŒ‚èµ·â½—è¿›ç¨‹ç›´â¾„â¼¦è¿›ç¨‹ç»ˆâ½Œï¼›å…¶â¼†ï¼Œâ¼¦è¿›ç¨‹çš„ç»ˆâ½ŒçŠ¶æ€é€šè¿‡waitçš„statuså‚æ•°è¿”å›</li>
  <li>execve(pathname,argv,envp)åŠ è½½â¼€ä¸ªæ–°ç¨‹åºï¼ˆè·¯å¾„åä¸ºpathnameï¼Œå‚æ•°åˆ—è¡¨ä¸ºargvï¼Œç¯å¢ƒå˜é‡åˆ—è¡¨ä¸ºenvpï¼‰åˆ°å½“å‰è¿›ç¨‹çš„å†…å­˜ã€‚è¿™å°†ä¸¢å¼ƒç°å­˜çš„ç¨‹åºâ½‚æœ¬æ®µï¼Œå¹¶ä¸ºæ–°ç¨‹åºé‡æ–°åˆ›å»ºæ ˆã€æ•°æ®æ®µä»¥åŠå †ã€‚é€šå¸¸å°†è¿™â¼€åŠ¨ä½œç§°ä¸ºæ‰§â¾â¼€ä¸ªæ–°ç¨‹åº</li>
</ul>

<p>åœ¨Goè¯­â¾”ä¸­ï¼Œæ²¡æœ‰ç›´æ¥æä¾›forkç³»ç»Ÿè°ƒâ½¤çš„å°è£…ï¼Œâ½½æ˜¯å°†forkå’Œexecveåˆâ¼†ä¸ºâ¼€ï¼Œæä¾›äº†syscall.ForkExecã€‚å¦‚æœæƒ³åªè°ƒâ½¤forkï¼Œå¾—â¾ƒâ¼°é€šè¿‡syscall.Syscall(syscall.SYS_FORK,0,0,0)å®ç°</p>

<h5 id="osprocess-åŠå…¶ç›¸å…³æ–¹æ³•">os.Process åŠå…¶ç›¸å…³æ–¹æ³•</h5>

<p>os.Process å­˜å‚¨äº†é€šè¿‡ StartProcess åˆ›å»ºçš„è¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type Process struct {
	Pid    int
	handle uintptr      // handle is accessed atomically on Windows
	isdone uint32       // process has been successfully waited on, non zero if true
	sigMu  sync.RWMutex // avoid race between wait and signal
}
</code></pre></div></div>

<h6 id="startprocess">StartProcess</h6>
<p>â¼€èˆ¬é€šè¿‡ StartProcess åˆ›å»º Process çš„å®ä¾‹</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func StartProcess(name string, argv []string, attr *ProcAttr) (*Process, error)
</code></pre></div></div>

<p>å®ƒä½¿â½¤æä¾›çš„ç¨‹åºåã€å‘½ä»¤â¾å‚æ•°ã€å±æ€§å¼€å§‹â¼€ä¸ªæ–°è¿›ç¨‹ã€‚StartProcessæ˜¯â¼€ä¸ªä½çº§åˆ«çš„æ¥â¼ã€‚os/execåŒ…æä¾›äº†â¾¼çº§åˆ«çš„æ¥â¼ï¼Œâ¼€èˆ¬åº”è¯¥å°½é‡ä½¿â½¤os/execåŒ…ã€‚å¦‚æœå‡ºé”™ï¼Œé”™è¯¯çš„ç±»å‹ä¼šæ˜¯*PathError</p>

<p>å…¶ä¸­çš„å‚æ•°attrï¼Œç±»å‹æ˜¯ProcAttrçš„æŒ‡é’ˆï¼Œâ½¤äºä¸ºStartProcessåˆ›å»ºæ–°è¿›ç¨‹æä¾›â¼€äº›å±æ€§ã€‚å®šä¹‰å¦‚ä¸‹</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type ProcAttr struct {
    // å¦‚æœ Dir â¾®ç©ºï¼Œâ¼¦è¿›ç¨‹ä¼šåœ¨åˆ›å»º Process å®ä¾‹å‰å…ˆè¿›â¼Šè¯¥â½¬å½•ã€‚ï¼ˆå³è®¾ä¸ºâ¼¦è¿›ç¨‹çš„å½“å‰â¼¯ä½œâ½¬
    å½•ï¼‰
    Dir string
    // å¦‚æœ Env â¾®ç©ºï¼Œå®ƒä¼šä½œä¸ºæ–°è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ã€‚å¿…é¡»é‡‡â½¤ Environ è¿”å›å€¼çš„æ ¼å¼ã€‚
    // å¦‚æœ Env ä¸º nilï¼Œå°†ä½¿â½¤ Environ å‡½æ•°çš„è¿”å›å€¼ã€‚
    Env []string
    // Files æŒ‡å®šè¢«æ–°è¿›ç¨‹ç»§æ‰¿çš„æ‰“å¼€â½‚ä»¶å¯¹è±¡ã€‚
    // å‰ä¸‰ä¸ªç»‘å®šä¸ºæ ‡å‡†è¾“â¼Šã€æ ‡å‡†è¾“å‡ºã€æ ‡å‡†é”™è¯¯è¾“å‡ºã€‚
    // ä¾èµ–åº•å±‚æ“ä½œç³»ç»Ÿçš„å®ç°å¯èƒ½ä¼šâ½€æŒé¢å¤–çš„â½‚ä»¶å¯¹è±¡ã€‚
    // nil ç›¸å½“äºåœ¨è¿›ç¨‹å¼€å§‹æ—¶å…³é—­çš„â½‚ä»¶å¯¹è±¡ã€‚
    Files []*File
    // æ“ä½œç³»ç»Ÿç‰¹å®šçš„åˆ›å»ºå±æ€§ã€‚
    // æ³¨æ„è®¾ç½®æœ¬å­—æ®µæ„å‘³ç€ä½ çš„ç¨‹åºå¯èƒ½ä¼šæ‰§â¾å¼‚å¸¸ç”šâ¾„åœ¨æŸäº›æ“ä½œç³»ç»Ÿä¸­â½†æ³•é€šè¿‡ç¼–è¯‘ã€‚è¿™æ—¶å€™å¯ä»¥
    é€šè¿‡ä¸ºç‰¹å®šç³»ç»Ÿè®¾ç½®ã€‚
    // çœ‹ syscall.SysProcAttr çš„å®šä¹‰ï¼Œå¯ä»¥çŸ¥é“â½¤äºæ§åˆ¶è¿›ç¨‹çš„ç›¸å…³å±æ€§ã€‚
    Sys *syscall.SysProcAttr
}
</code></pre></div></div>

<h6 id="findprocess">FindProcess</h6>

<p>FindProcesså¯ä»¥é€šè¿‡pidæŸ¥æ‰¾â¼€ä¸ªè¿â¾ä¸­çš„è¿›ç¨‹ã€‚è¯¥å‡½æ•°è¿”å›çš„Processå¯¹è±¡å¯ä»¥â½¤äºè·å–å…³äºåº•å±‚æ“ä½œç³»ç»Ÿè¿›ç¨‹çš„ä¿¡æ¯ã€‚åœ¨Unixç³»ç»Ÿä¸­ï¼Œæ­¤å‡½æ•°æ€»æ˜¯æˆåŠŸï¼Œå³ä½¿pidå¯¹åº”çš„è¿›ç¨‹ä¸å­˜åœ¨</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func FindProcess(pid int) (*Process, error)
</code></pre></div></div>

<p>Processæä¾›äº†å››ä¸ªâ½…æ³•ï¼šKillã€Signalã€Waitå’ŒReleaseã€‚å…¶ä¸­Killå’ŒSignalè·Ÿä¿¡å·ç›¸å…³ï¼Œâ½½Killå®é™…ä¸Šå°±æ˜¯è°ƒâ½¤Signalï¼Œå‘é€äº†SIGKILLä¿¡å·ï¼Œå¼ºåˆ¶è¿›ç¨‹é€€å‡ºã€‚Releaseâ½…æ³•â½¤äºé‡Šæ”¾Processå¯¹è±¡ç›¸å…³çš„èµ„æºï¼Œä»¥ä¾¿å°†æ¥å¯ä»¥è¢«å†ä½¿â½¤ã€‚è¯¥â½…æ³•åªæœ‰åœ¨ç¡®å®šæ²¡æœ‰è°ƒâ½¤Waitæ—¶æ‰éœ€è¦è°ƒâ½¤ã€‚Unixä¸­ï¼Œè¯¥â½…æ³•çš„å†…éƒ¨å®ç°åªæ˜¯å°†Processçš„pidç½®ä¸º-1ã€‚</p>

<p>Wait æ–¹æ³•</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> func (p *Process) Wait() (*ProcessState, error)
</code></pre></div></div>

<p>åœ¨å¤šè¿›ç¨‹åº”â½¤ç¨‹åºçš„è®¾è®¡ä¸­ï¼Œâ½—è¿›ç¨‹éœ€è¦çŸ¥é“æŸä¸ªâ¼¦è¿›ç¨‹ä½•æ—¶æ”¹å˜äº†çŠ¶æ€â€”â€”â¼¦è¿›ç¨‹ç»ˆâ½Œæˆ–å› æ”¶åˆ°ä¿¡å·â½½åœâ½Œã€‚Waitâ½…æ³•å°±æ˜¯â¼€ç§â½¤äºç›‘æ§â¼¦è¿›ç¨‹çš„æŠ€æœ¯ã€‚Waitâ½…æ³•é˜»å¡ç›´åˆ°è¿›ç¨‹é€€å‡ºï¼Œç„¶åè¿”å›â¼€ä¸ªProcessStateæè¿°è¿›ç¨‹çš„çŠ¶æ€å’Œå¯èƒ½çš„é”™è¯¯ã€‚Waitâ½…æ³•ä¼šé‡Šæ”¾ç»‘å®šåˆ°Processçš„æ‰€æœ‰èµ„æºã€‚åœ¨â¼¤å¤šæ•°æ“ä½œç³»ç»Ÿä¸­ï¼ŒProcesså¿…é¡»æ˜¯å½“å‰è¿›ç¨‹çš„â¼¦è¿›ç¨‹ï¼Œå¦åˆ™ä¼šè¿”å›é”™è¯¯</p>

<p>ProcessState çš„å†…éƒ¨ç»“æ„</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type ProcessState struct {
    pid int // The process's id.
    status syscall.WaitStatus // System-dependent status info.
    rusage *syscall.Rusage
}
</code></pre></div></div>

<p>ProcessStateä¿å­˜äº†Waitå‡½æ•°æŠ¥å‘Šçš„æŸä¸ªè¿›ç¨‹çš„ä¿¡æ¯ã€‚statusè®°å½•äº†çŠ¶æ€åŸå› ï¼Œé€šè¿‡syscal.WaitStatusç±»å‹å®šä¹‰çš„â½…æ³•å¯ä»¥åˆ¤æ–­</p>

<ul>
  <li>Exited()ï¼šæ˜¯å¦æ­£å¸¸é€€å‡ºï¼Œå¦‚è°ƒâ½¤os.Exitï¼›</li>
  <li>Signaled()ï¼šæ˜¯å¦æ”¶åˆ°æœªå¤„ç†ä¿¡å·â½½ç»ˆâ½Œï¼›</li>
  <li>CoreDump()ï¼šæ˜¯å¦æ”¶åˆ°æœªå¤„ç†ä¿¡å·â½½ç»ˆâ½Œï¼ŒåŒæ—¶â½£æˆcoredumpâ½‚ä»¶ï¼Œå¦‚SIGABRT</li>
  <li>Stopped()ï¼šæ˜¯å¦å› ä¿¡å·â½½åœâ½Œï¼ˆSIGSTOPï¼‰ï¼›</li>
  <li>Continued()ï¼šæ˜¯å¦å› æ”¶åˆ°ä¿¡å·SIGCONTâ½½æ¢å¤</li>
</ul>

<p>ç¤ºä¾‹ç¨‹åº</p>

<p>æ‰§è¡Œå¤–éƒ¨å‘½ä»¤ ls,å¹¶é€šè¿‡ProcessStateè·å–æ‰§è¡Œçš„åŸºæœ¬ä¿¡æ¯</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="n">import</span> <span class="p">(</span>
	<span class="s2">"fmt"</span>
	<span class="s2">"os"</span>
	<span class="s2">"os/exec"</span>
	<span class="s2">"path/filepath"</span>
	<span class="s2">"time"</span>
<span class="p">)</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">len</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">Args</span><span class="p">)</span> <span class="p">&lt;</span> <span class="m">2</span> <span class="p">{</span>
		<span class="n">fmt</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s2">"Usage: %s [command]</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">Args</span><span class="p">[</span><span class="m">0</span><span class="p">])</span>
		<span class="n">os</span><span class="p">.</span><span class="k">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">cmdName</span> <span class="p">:=</span> <span class="n">os</span><span class="p">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span>
	<span class="k">if</span> <span class="n">filepath</span><span class="p">.</span><span class="n">Base</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="p">])</span> <span class="p">==</span> <span class="n">os</span><span class="p">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">lp</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">exec</span><span class="p">.</span><span class="n">LookPath</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="p">]);</span> <span class="n">err</span> <span class="c1">!= nil {
</span>			<span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"look path error:"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
			<span class="n">os</span><span class="p">.</span><span class="k">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cmdName</span> <span class="p">=</span> <span class="n">lp</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">procAttr</span> <span class="p">:=</span> <span class="p">&amp;</span><span class="n">os</span><span class="p">.</span><span class="n">ProcAttr</span><span class="p">{</span>
		<span class="n">Files</span><span class="p">:</span> <span class="p">[]*</span><span class="n">os</span><span class="p">.</span><span class="n">File</span><span class="p">{</span><span class="n">os</span><span class="p">.</span><span class="n">Stdin</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">Stdout</span><span class="p">,</span> <span class="n">os</span><span class="p">.</span><span class="n">Stderr</span><span class="p">},</span>
	<span class="p">}</span>
	<span class="n">cwd</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">os</span><span class="p">.</span><span class="n">Getwd</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">err</span> <span class="c1">!= nil {
</span>		<span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"look path error:"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
		<span class="n">os</span><span class="p">.</span><span class="k">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">start</span> <span class="p">:=</span> <span class="n">time</span><span class="p">.</span><span class="n">Now</span><span class="p">()</span>
	<span class="n">process</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">os</span><span class="p">.</span><span class="n">StartProcess</span><span class="p">(</span><span class="n">cmdName</span><span class="p">,</span> <span class="p">[]</span><span class="k">string</span><span class="p">{</span><span class="n">cwd</span><span class="p">},</span> <span class="n">procAttr</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="c1">!= nil {
</span>		<span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"start process error:"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
		<span class="n">os</span><span class="p">.</span><span class="k">Exit</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">processState</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">process</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">err</span> <span class="c1">!= nil {
</span>		<span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"wait error:"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
		<span class="n">os</span><span class="p">.</span><span class="k">Exit</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">()</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"real"</span><span class="p">,</span> <span class="n">time</span><span class="p">.</span><span class="n">Now</span><span class="p">().</span><span class="n">Sub</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"user"</span><span class="p">,</span> <span class="n">processState</span><span class="p">.</span><span class="n">UserTime</span><span class="p">())</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"system"</span><span class="p">,</span> <span class="n">processState</span><span class="p">.</span><span class="n">SystemTime</span><span class="p">())</span>
<span class="p">}</span>

<span class="err">è¾“å‡º</span>

<span class="n">cmd</span>             <span class="n">main</span><span class="p">.</span><span class="n">go</span>         <span class="n">sort</span><span class="p">.</span><span class="n">go</span>         <span class="n">time_test</span><span class="p">.</span><span class="n">go</span>
<span class="n">cmd</span><span class="p">.</span><span class="n">go</span>          <span class="n">ring</span><span class="p">.</span><span class="n">go</span>         <span class="n">time</span><span class="p">.</span><span class="n">go</span>         <span class="n">timer</span><span class="p">.</span><span class="n">go</span>

<span class="k">real</span> <span class="m">6.30397</span><span class="n">ms</span>
<span class="n">user</span> <span class="m">1.483</span><span class="n">ms</span>
<span class="nf">system</span> <span class="m">4.023</span><span class="n">ms</span>
</code></pre></div></div>

<h5 id="è¿è¡Œå¤–éƒ¨å‘½ä»¤">è¿è¡Œå¤–éƒ¨å‘½ä»¤</h5>

<p>é€šè¿‡osåŒ…å¯ä»¥åšåˆ°è¿â¾å¤–éƒ¨å‘½ä»¤ï¼Œå¦‚å‰â¾¯çš„ä¾‹â¼¦ã€‚ä¸è¿‡ï¼ŒGoæ ‡å‡†åº“ä¸ºæˆ‘ä»¬å°è£…äº†æ›´å¥½â½¤çš„åŒ…ï¼šos/execï¼Œè¿â¾å¤–éƒ¨å‘½ä»¤ï¼Œåº”è¯¥ä¼˜å…ˆä½¿â½¤å®ƒï¼Œå®ƒåŒ…è£…äº†os.StartProcesså‡½æ•°ä»¥ä¾¿æ›´å®¹æ˜“çš„é‡å®šå‘æ ‡å‡†è¾“â¼Šå’Œè¾“å‡ºï¼Œä½¿â½¤ç®¡é“è¿æ¥I/Oï¼Œä»¥åŠä½œå…¶å®ƒçš„â¼€äº›è°ƒæ•´ã€‚</p>

<h6 id="æŸ¥æ‰¾å¯æ‰§ç¨‹åº">æŸ¥æ‰¾å¯æ‰§â¾ç¨‹åº</h6>

<p>exec.LookPathå‡½æ•°åœ¨PATHæŒ‡å®šâ½¬å½•ä¸­æœç´¢å¯æ‰§â¾ç¨‹åºï¼Œå¦‚fileä¸­æœ‰/ï¼Œåˆ™åªåœ¨å½“å‰â½¬å½•æœç´¢ã€‚è¯¥å‡½æ•°è¿”å›å®Œæ•´è·¯å¾„æˆ–ç›¸å¯¹äºå½“å‰è·¯å¾„çš„â¼€ä¸ªç›¸å¯¹è·¯å¾„ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func LookPath(file string) (string, error)

// ä¾‹
str, err := exec.LookPath("/Users/AllWorkSpace/GoWorkSpace/src/base/")
</code></pre></div></div>

<h6 id="cmdç›¸å…³å‘½ä»¤">CMDç›¸å…³å‘½ä»¤</h6>

<p>Cmdç»“æ„ä»£è¡¨â¼€ä¸ªæ­£åœ¨å‡†å¤‡æˆ–è€…åœ¨æ‰§â¾ä¸­çš„å¤–éƒ¨å‘½ä»¤ï¼Œè°ƒâ½¤äº†Runã€Outputæˆ–CombinedOutputåï¼ŒCmdå®ä¾‹ä¸èƒ½è¢«é‡â½¤</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type Cmd struct {
	// Path æ˜¯å°†è¦æ‰§â¾çš„å‘½ä»¤è·¯å¾„ã€‚
    // è¯¥å­—æ®µä¸èƒ½ä¸ºç©ºï¼ˆä¹Ÿæ˜¯å”¯â¼€â¼€ä¸ªä¸èƒ½ä¸ºç©ºçš„å­—æ®µï¼‰ï¼Œå¦‚ä¸ºç›¸å¯¹è·¯å¾„ä¼šç›¸å¯¹äº Dir å­—æ®µã€‚
    // é€šè¿‡ Command åˆå§‹åŒ–æ—¶ï¼Œä¼šåœ¨éœ€è¦æ—¶è°ƒâ½¤ LookPath è·å¾—å®Œæ•´çš„è·¯å¾„
	Path string

	// Args å­˜æ”¾ç€å‘½ä»¤çš„å‚æ•°ï¼Œç¬¬â¼€ä¸ªå€¼æ˜¯è¦æ‰§â¾çš„å‘½ä»¤ï¼ˆArgs[0])ï¼›å¦‚æœä¸ºç©ºåˆ‡â½šæˆ–è€…nilï¼Œä½¿â½¤ {Path} è¿â¾ã€‚
    // â¼€èˆ¬æƒ…å†µä¸‹ï¼ŒPath å’Œ Args éƒ½åº”è¢« Command å‡½æ•°è®¾å®š
	Args []string


	// Env æŒ‡å®šè¿›ç¨‹çš„ç¯å¢ƒå˜é‡ï¼Œå¦‚ä¸º nilï¼Œåˆ™ä½¿â½¤å½“å‰è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ï¼Œå³ os.Environ()ï¼Œâ¼€èˆ¬å°±æ˜¯å½“å‰ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡
	Env []string

	// Dir æŒ‡å®šå‘½ä»¤çš„â¼¯ä½œâ½¬å½•ã€‚å¦‚ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œä¼šåœ¨è°ƒâ½¤è€…çš„è¿›ç¨‹å½“å‰â¼¯ä½œâ½¬å½•ä¸‹æ‰§â¾
	Dir string
	// Stdin æŒ‡å®šè¿›ç¨‹çš„æ ‡å‡†è¾“â¼Šï¼Œå¦‚ä¸º nilï¼Œè¿›ç¨‹ä¼šä»ç©ºè®¾å¤‡è¯»å–ï¼ˆos.DevNullï¼‰
    // å¦‚æœ Stdin æ˜¯ *os.File çš„å®ä¾‹ï¼Œè¿›ç¨‹çš„æ ‡å‡†è¾“â¼Šä¼šç›´æ¥æŒ‡å‘è¿™ä¸ªâ½‚ä»¶
    // å¦åˆ™ï¼Œä¼šåœ¨â¼€ä¸ªå•ç‹¬çš„ goroutine ä¸­ä» Stdin ä¸­è¯»æ•°æ®ï¼Œç„¶åå°†æ•°æ®é€šè¿‡ç®¡é“ä¼ é€’åˆ°è¯¥å‘½ä»¤ä¸­
    //ï¼ˆä¹Ÿå°±æ˜¯ä» Stdin è¯»åˆ°æ•°æ®åï¼Œå†™â¼Šç®¡é“ï¼Œè¯¥å‘½ä»¤å¯ä»¥ä»ç®¡é“è¯»åˆ°è¿™ä¸ªæ•°æ®ï¼‰ã€‚åœ¨ goroutine åœâ½Œæ•°æ®
    // æ‹·â»‰ä¹‹å‰ï¼ˆåœâ½Œçš„åŸå› å¦‚é‡åˆ°EOFæˆ–å…¶ä»–é”™è¯¯ï¼Œæˆ–ç®¡é“çš„ write ç«¯é”™è¯¯ï¼‰ï¼ŒWait â½…æ³•ä¼šâ¼€ç›´å µå¡
	Stdin io.Reader

	// Stdout å’Œ Stderr æŒ‡å®šè¿›ç¨‹çš„æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºã€‚
    // å¦‚æœä»»â¼€ä¸ªä¸º nilï¼ŒRun â½…æ³•ä¼šå°†å¯¹åº”çš„â½‚ä»¶æè¿°ç¬¦å…³è”åˆ°ç©ºè®¾å¤‡ï¼ˆos.DevNullï¼‰
    // å¦‚æœä¸¤ä¸ªå­—æ®µç›¸åŒï¼ŒåŒâ¼€æ—¶é—´æœ€å¤šæœ‰â¼€ä¸ªçº¿ç¨‹å¯ä»¥å†™â¼Š
	Stdout io.Writer
	Stderr io.Writer

	// ExtraFiles specifies additional open files to be inherited by the
	// new process. It does not include standard input, standard output, or
	// standard error. If non-nil, entry i becomes file descriptor 3+i.
	//
	// ExtraFiles is not supported on Windows.
	ExtraFiles []*os.File

	// SysProcAttr holds optional, operating system-specific attributes.
	// Run passes it to os.StartProcess as the os.ProcAttr's Sys field.
	SysProcAttr *syscall.SysProcAttr

	// Process is the underlying process, once started.
	Process *os.Process

	// ProcessState contains information about an exited process,
	// available after a call to Wait or Run.
	ProcessState *os.ProcessState

	ctx             context.Context // nil means none
	lookPathErr     error           // LookPath error, if any.
	finished        bool            // when Wait was called
	childFiles      []*os.File
	closeAfterStart []io.Closer
	closeAfterWait  []io.Closer
	goroutine       []func() error
	errch           chan error // one send per goroutine
	waitDone        chan struct{}
}
</code></pre></div></div>

<p>æ‰§è¡Œæ–¹æ³•</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// CMD
func Command(namme string, agg ...strig)*Cmd
</code></pre></div></div>
<p>è¯¥å‡½æ•°è¿”å›ä¸€ä¸ª<em>Cmd,ç”¨äºä½¿ç”¨ç»™å‡ºçš„å‚æ•°æ‰§è¡ŒnameæŒ‡å®šçš„ç¨‹åºã€‚
è¿”å›çš„</em>Cmdåªè®¾å®šäº†Pathå’ŒArgsä¸¤ä¸ªå­—æ®µ</p>

<p>å¦‚æœnameä¸å¥½å–Šè·¯å¾„åˆ†éš”ç¬¦ï¼Œå°†ä½¿ç”¨LookPathè·å–å®Œæ•´è·¯å¾„;å¦åˆ™ç›´æ¥ä½¿ç”¨name</p>

<p>å¾—åˆ°*Cmdå®ä¾‹è¿‡å:</p>
<ul>
  <li>è°ƒç”¨ Start(),æ¥ç€è°ƒç”¨Wait(),ç„¶åä¼šé˜»å¡ç›´åˆ°å‘½ä»¤æ‰§è¡Œå®Œæˆ</li>
  <li>è°ƒç”¨ Run(),å®ƒå†…éƒ¨ä¼šè°ƒç”¨Start(),æ¥ç€è°ƒç”¨Wait()</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Start
func (c *Cmd)Start() error

å¼€å§‹æ‰§â¾cåŒ…å«çš„å‘½ä»¤ï¼Œä½†å¹¶ä¸ä¼šç­‰å¾…è¯¥å‘½ä»¤å®Œæˆå³è¿”å›ã€‚Waitâ½…æ³•ä¼šè¿”å›å‘½ä»¤çš„é€€å‡ºçŠ¶æ€ç å¹¶åœ¨å‘½ä»¤æ‰§â¾å®Œåé‡Šæ”¾ç›¸å…³çš„èµ„æºã€‚å†…éƒ¨è°ƒâ½¤os.StartProcessï¼Œæ‰§â¾forkExecã€‚


// Wait
func (c *Cmd)Wait() error

Waitä¼šé˜»å¡ç›´åˆ°è¯¥å‘½ä»¤æ‰§â¾å®Œæˆï¼Œè¯¥å‘½ä»¤å¿…é¡»æ˜¯å…ˆé€šè¿‡Startæ‰§â¾ã€‚å¦‚æœå‘½ä»¤æˆåŠŸæ‰§â¾ï¼Œstdinã€stdoutã€stderræ•°æ®ä¼ é€’æ²¡æœ‰é—®é¢˜ï¼Œå¹¶ä¸”è¿”å›çŠ¶æ€ç ä¸º0ï¼Œâ½…æ³•çš„è¿”å›å€¼ä¸ºnilï¼›å¦‚æœå‘½ä»¤æ²¡æœ‰æ‰§â¾æˆ–è€…æ‰§â¾å¤±è´¥ï¼Œä¼šè¿”å›*ExitErrorç±»å‹çš„é”™è¯¯ï¼›å¦åˆ™è¿”å›çš„errorå¯èƒ½æ˜¯è¡¨ç¤ºI/Oé—®é¢˜ã€‚å¦‚æœc.Stdinä¸æ˜¯*os.Fileç±»å‹ï¼ŒWaitä¼šç­‰å¾…ï¼Œç›´åˆ°æ•°æ®ä»c.Stdinæ‹·â»‰åˆ°è¿›ç¨‹çš„æ ‡å‡†è¾“â¼Šã€‚Waitâ½…æ³•ä¼šåœ¨å‘½ä»¤è¿”å›åé‡Šæ”¾ç›¸å…³çš„èµ„æºã€‚


//Output
// Outputè¿è¡Œå‘½ä»¤å¹¶è¿”å›å…¶æ ‡å‡†è¾“å‡ºã€‚
// é”™è¯¯é€šå¸¸éƒ½æ˜¯* ExitErrorç±»å‹ã€‚
//å¦‚æœc.Stderrä¸ºnilï¼Œåˆ™Outputå¡«å……ExitError.Stderrã€‚
func (c *Cmd) Output() ([]byte, error)


//CombinedOutput
Output()åªè¿”å›Stdoutçš„ç»“æœï¼Œâ½½CombinedOutputç»„åˆStdoutå’ŒStderrçš„è¾“å‡ºï¼Œå³Stdoutå’ŒStderréƒ½èµ‹å€¼ä¸ºåŒâ¼€ä¸ªbytes.Bufferã€‚
</code></pre></div></div>

<p>StdoutPipeã€StderrPipe å’Œ StdinPipe</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>é™¤äº†ä¸Šâ¾¯ä»‹ç»çš„Outputå’ŒCombinedOutputç›´æ¥è·å–å‘½ä»¤è¾“å‡ºç»“æœå¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡StdoutPipeè¿”å›io.ReadCloseræ¥è·å–è¾“å‡ºï¼›ç›¸åº”çš„StderrPipeå¾—åˆ°é”™è¯¯ä¿¡æ¯ï¼›â½½StdinPipeåˆ™å¯ä»¥å¾€å‘½ä»¤å†™â¼Šæ•°æ®

func (c *Cmd) StdoutPipe() (io.ReadCloser, error)

StdoutPipeâ½…æ³•è¿”å›â¼€ä¸ªåœ¨å‘½ä»¤Startæ‰§â¾åä¸å‘½ä»¤æ ‡å‡†è¾“å‡ºå…³è”çš„ç®¡é“ã€‚Waitâ½…æ³•ä¼šåœ¨å‘½ä»¤ç»“æŸåä¼šå…³é—­è¿™ä¸ªç®¡é“ï¼Œæ‰€ä»¥â¼€èˆ¬ä¸éœ€è¦â¼¿åŠ¨å…³é—­è¯¥ç®¡é“ã€‚ä½†æ˜¯åœ¨ä»ç®¡é“è¯»å–å®Œå…¨éƒ¨æ•°æ®ä¹‹å‰è°ƒâ½¤Waitå‡ºé”™äº†ï¼Œåˆ™å¿…é¡»â¼¿åŠ¨å…³é—­

func (c *Cmd) StderrPipe() (io.ReadCloser, error)

StderrPipeâ½…æ³•è¿”å›â¼€ä¸ªåœ¨å‘½ä»¤Startæ‰§â¾åä¸å‘½ä»¤æ ‡å‡†é”™è¯¯è¾“å‡ºå…³è”çš„ç®¡é“ã€‚Waitâ½…æ³•ä¼šåœ¨å‘½ä»¤ç»“æŸåä¼šå…³é—­è¿™ä¸ªç®¡é“ï¼Œâ¼€èˆ¬ä¸éœ€è¦â¼¿åŠ¨å…³é—­è¯¥ç®¡é“ã€‚ä½†æ˜¯åœ¨ä»ç®¡é“è¯»å–å®Œå…¨éƒ¨æ•°æ®ä¹‹å‰è°ƒâ½¤Waitå‡ºé”™äº†ï¼Œåˆ™å¿…é¡»â¼¿åŠ¨å…³é—­

func (c *Cmd) StdinPipe() (io.WriteCloser, error)

StdinPipeâ½…æ³•è¿”å›â¼€ä¸ªåœ¨å‘½ä»¤Startæ‰§â¾åä¸å‘½ä»¤æ ‡å‡†è¾“â¼Šå…³è”çš„ç®¡é“ã€‚Waitâ½…æ³•ä¼šåœ¨å‘½ä»¤ç»“æŸåä¼šå…³é—­è¿™ä¸ªç®¡é“ã€‚å¿…è¦æ—¶è°ƒâ½¤è€…å¯ä»¥è°ƒâ½¤Closeâ½…æ³•æ¥å¼ºâ¾å…³é—­ç®¡é“ã€‚ä¾‹å¦‚ï¼Œæ ‡å‡†è¾“â¼Šå·²ç»å…³é—­äº†ï¼Œå‘½ä»¤æ‰§â¾æ‰å®Œæˆï¼Œè¿™æ—¶è°ƒâ½¤è€…éœ€è¦æ˜¾ç¤ºå…³é—­ç®¡é“

å› ä¸º Wait ä¹‹åï¼Œä¼šå°†ç®¡é“å…³é—­ï¼Œæ‰€ä»¥ï¼Œè¦ä½¿â½¤è¿™äº›â½…æ³•ï¼Œåªèƒ½ä½¿â½¤ Start + Wait ç»„
åˆï¼Œä¸èƒ½ä½¿â½¤ Run
</code></pre></div></div>

<h6 id="æ‰§è¡Œå¤–éƒ¨å‘½ä»¤">æ‰§è¡Œå¤–éƒ¨å‘½ä»¤</h6>

<p>é€šè¿‡Cmdå®ä¾‹åï¼Œæœ‰ä¸¤ç§â½…å¼è¿â¾å‘½ä»¤ã€‚æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬ä¸åªæ˜¯ç®€å•çš„è¿â¾å‘½ä»¤ï¼Œè¿˜å¸Œæœ›èƒ½æ§åˆ¶å‘½ä»¤çš„è¾“â¼Šå’Œè¾“å‡ºã€‚é€šè¿‡ä¸Šâ¾¯çš„APIä»‹ç»ï¼Œæ§åˆ¶è¾“â¼Šè¾“å‡ºæœ‰â¼ç§â½…æ³•</p>

<ul>
  <li>å¾—åˆ°Cmdå®ä¾‹åï¼Œç›´æ¥ç»™å®ƒçš„å­—æ®µStdinã€Stdoutå’ŒStderrèµ‹å€¼</li>
  <li>é€šè¿‡ Output æˆ– CombinedOutput è·å¾—è¾“å‡º</li>
  <li>é€šè¿‡å¸¦ Pipe åç¼€çš„â½…æ³•è·å¾—ç®¡é“ï¼Œâ½¤äºè¾“â¼Šæˆ–è¾“å‡º</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="n">import</span> <span class="p">(</span>
	<span class="s2">"bytes"</span>
	<span class="s2">"os/exec"</span>
<span class="p">)</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>

<span class="n">func</span> <span class="n">FillStd</span><span class="p">(</span><span class="n">name</span> <span class="k">string</span><span class="p">,</span> <span class="n">arg</span> <span class="p">...</span><span class="k">string</span><span class="p">)</span> <span class="p">([]</span><span class="n">byte</span><span class="p">,</span> <span class="n">error</span><span class="p">){</span>
	<span class="n">cmd</span> <span class="p">:=</span> <span class="n">exec</span><span class="p">.</span><span class="n">Command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">arg</span><span class="p">...)</span>
	<span class="n">var</span> <span class="n">out</span> <span class="p">=</span> <span class="n">new</span><span class="p">(</span><span class="n">bytes</span><span class="p">.</span><span class="n">Buffer</span><span class="p">)</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">Stdout</span> <span class="p">=</span> <span class="n">out</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">Stderr</span> <span class="p">=</span> <span class="n">out</span>
	<span class="n">err</span> <span class="p">:=</span> <span class="n">cmd</span><span class="p">.</span><span class="nf">Run</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">err</span> <span class="c1">!= nil {
</span>		<span class="n">return</span> <span class="n">nil</span><span class="p">,</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="n">return</span> <span class="n">out</span><span class="p">.</span><span class="n">Bytes</span><span class="p">(),</span> <span class="n">nil</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">UseOutput</span><span class="p">(</span><span class="n">name</span> <span class="k">string</span><span class="p">,</span> <span class="n">arg</span> <span class="p">...</span><span class="k">string</span><span class="p">)</span> <span class="p">([]</span><span class="n">byte</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">return</span> <span class="n">exec</span><span class="p">.</span><span class="n">Command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">arg</span><span class="p">...).</span><span class="n">Output</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">UsePipe</span><span class="p">(</span><span class="n">name</span> <span class="k">string</span><span class="p">,</span> <span class="n">arg</span> <span class="p">...</span><span class="k">string</span><span class="p">)</span> <span class="p">([]</span><span class="n">byte</span><span class="p">,</span> <span class="n">error</span><span class="p">){</span>
	<span class="n">cmd</span> <span class="p">:=</span> <span class="n">exec</span><span class="p">.</span><span class="n">Command</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">arg</span><span class="p">...)</span>
	<span class="n">stdout</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">StdoutPipe</span><span class="p">()</span>
	<span class="k">if</span> <span class="n">err</span> <span class="c1">!= nil {
</span>		<span class="n">return</span> <span class="n">nil</span><span class="p">,</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">err</span> <span class="p">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span> <span class="n">err</span> <span class="c1">!= nil {
</span>
		<span class="n">return</span> <span class="n">nil</span><span class="p">,</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="n">var</span> <span class="n">out</span> <span class="p">=</span> <span class="n">make</span><span class="p">([]</span><span class="n">byte</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1024</span><span class="p">)</span>
	<span class="n">for</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="p">:=</span> <span class="n">make</span><span class="p">([]</span><span class="n">byte</span><span class="p">,</span> <span class="m">128</span><span class="p">)</span>
		<span class="n">n</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">stdout</span><span class="p">.</span><span class="n">Read</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
		<span class="n">out</span> <span class="p">=</span> <span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[:</span><span class="n">n</span><span class="p">]...)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="c1">!= nil {
</span>			<span class="k">break</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="n">err</span> <span class="p">=</span> <span class="n">cmd</span><span class="p">.</span><span class="nf">Wait</span><span class="p">();</span> <span class="n">err</span> <span class="c1">!= nil {
</span>		<span class="n">return</span> <span class="n">nil</span><span class="p">,</span> <span class="n">err</span>
	<span class="p">}</span>
	<span class="n">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">nil</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="è¿›ç¨‹ç›¸å…³">è¿›ç¨‹ç›¸å…³</h3>

<h5 id="è·å–è¿›ç¨‹id">è·å–è¿›ç¨‹ID</h5>
<p>æ¯ä¸ªè¿›ç¨‹éƒ½ä¼šæœ‰â¼€ä¸ªè¿›ç¨‹IDï¼Œå¯ä»¥é€šè¿‡os.Getpidè·å¾—ã€‚åŒæ—¶ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰åˆ›å»ºâ¾ƒâ¼°çš„â½—è¿›ç¨‹ï¼Œé€šè¿‡os.Getppidè·å¾—</p>

<h5 id="è¿›ç¨‹å‡­è¯">è¿›ç¨‹å‡­è¯</h5>
<p>unixä¸­è¿›ç¨‹éƒ½æœ‰â¼€å¥—æ•°å­—è¡¨ç¤ºçš„â½¤æˆ·ID(UID)å’Œç»„ID(GID)ï¼Œæœ‰æ—¶ä¹Ÿå°†è¿™äº›IDç§°ä¹‹ä¸ºè¿›ç¨‹å‡­è¯ã€‚Windowsä¸‹æ€»æ˜¯-1ã€‚</p>

<h5 id="å®é™…ç”¨æˆ·idå’Œå®é™…ç»„id">å®é™…ç”¨æˆ·IDå’Œå®é™…ç»„ID</h5>
<p>å®é™…â½¤æˆ·IDï¼ˆrealuserIDï¼‰å’Œå®é™…ç»„IDï¼ˆrealgroupIDï¼‰ç¡®å®šäº†è¿›ç¨‹æ‰€å±çš„â½¤æˆ·å’Œç»„ã€‚ç™»å½•shellä»/etc/passwdâ½‚ä»¶è¯»å–â½¤æˆ·IDå’Œç»„IDã€‚å½“åˆ›å»ºæ–°è¿›ç¨‹æ—¶ï¼ˆå¦‚shellæ‰§â¾ç¨‹åºï¼‰ï¼Œå°†ä»å…¶â½—è¿›ç¨‹ä¸­ç»§æ‰¿è¿™äº›IDã€‚å¯é€šè¿‡os.Getuid()å’Œos.Getgid()è·å–å½“å‰è¿›ç¨‹çš„å®é™…â½¤æˆ·IDå’Œå®é™…ç»„ID</p>

<h5 id="æœ‰æ•ˆæˆ·-id-å’Œæœ‰æ•ˆç»„-id">æœ‰æ•ˆâ½¤æˆ· ID å’Œæœ‰æ•ˆç»„ ID</h5>

<p>â¼¤å¤šæ•°Unixå®ç°ä¸­ï¼Œå½“è¿›ç¨‹å°è¯•æ‰§â¾å„ç§æ“ä½œï¼ˆå³ç³»ç»Ÿè°ƒâ½¤ï¼‰æ—¶ï¼Œå°†ç»“åˆæœ‰æ•ˆâ½¤æˆ·IDã€æœ‰æ•ˆç»„IDï¼Œè¿åŒè¾…åŠ©ç»„IDâ¼€èµ·æ¥ç¡®å®šæˆäºˆè¿›ç¨‹çš„æƒé™ã€‚å†…æ ¸è¿˜ä¼šä½¿â½¤æœ‰æ•ˆâ½¤æˆ·IDæ¥å†³å®šâ¼€ä¸ªè¿›ç¨‹æ˜¯å¦èƒ½å‘å¦â¼€ä¸ªè¿›ç¨‹å‘é€ä¿¡å·ã€‚æœ‰æ•ˆâ½¤æˆ·IDä¸º0ï¼ˆrootçš„â½¤æˆ·IDï¼‰çš„è¿›ç¨‹æ‹¥æœ‰è¶…çº§â½¤æˆ·çš„æ‰€æœ‰æƒé™ã€‚è¿™æ ·çš„è¿›ç¨‹â¼œç§°ä¸ºç‰¹æƒçº§è¿›ç¨‹ï¼ˆprivilegedprocessï¼‰ã€‚æŸäº›ç³»ç»Ÿè°ƒâ½¤åªèƒ½ç”±ç‰¹æƒçº§è¿›ç¨‹æ‰§â¾ã€‚å¯é€šè¿‡os.Geteuid()å’Œos.Getegid()è·å–å½“å‰è¿›ç¨‹çš„æœ‰æ•ˆâ½¤æˆ·IDï¼ˆeffectiveuserIDï¼‰å’Œæœ‰æ•ˆç»„IDï¼ˆeffectviegroupIDï¼‰ã€‚</p>

<p>é€šå¸¸ï¼Œæœ‰æ•ˆâ½¤æˆ·IDåŠç»„IDä¸å…¶ç›¸åº”çš„å®é™…IDç›¸ç­‰ï¼Œä½†æœ‰ä¸¤ç§â½…æ³•èƒ½å¤Ÿè‡´ä½¿â¼†è€…ä¸åŒã€‚â¼€æ˜¯ä½¿â½¤ç›¸å…³ç³»ç»Ÿè°ƒâ½¤ï¼›â¼†æ˜¯æ‰§â¾set-user-IDå’Œset-group-IDç¨‹åº</p>

<p>åŒ…os/userå…è®¸é€šè¿‡åç§°æˆ–IDæŸ¥è¯¢â½¤æˆ·è´¦å·</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type User struct {
    Uid string // user id
    Gid string // primary group id
    Username string
    Name string
    HomeDir string
}
</code></pre></div></div>

<p>Currentå‡½æ•°å¯ä»¥è·å–å½“å‰â½¤æˆ·è´¦å·ã€‚â½½Lookupå’ŒLookupIdåˆ™åˆ†åˆ«æ ¹æ®â½¤æˆ·åå’Œâ½¤æˆ·IDæŸ¥è¯¢â½¤æˆ·ã€‚å¦‚æœå¯¹åº”çš„â½¤æˆ·ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›user.UnknownUserErroræˆ–user.UnknownUserIdError</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fmt.Println(user.Current())
fmt.Println(user.Lookup("yangping"))
fmt.Println(user.LookupId("0"))


&amp;{501 20 yangping æ¨å¹³ /Users/yangping} &lt;nil&gt;
&amp;{501 20 yangping æ¨å¹³ /Users/yangping} &lt;nil&gt;
&amp;{0 0 root System Administrator /var/root} &lt;nil&gt;
</code></pre></div></div>

<h4 id="çº¿ç¨‹">çº¿ç¨‹</h4>

<p>ä¸è¿›ç¨‹ç±»ä¼¼ï¼Œçº¿ç¨‹æ˜¯å…è®¸åº”â½¤ç¨‹åºå¹¶å‘æ‰§â¾å¤šä¸ªä»»åŠ¡çš„â¼€ç§æœºåˆ¶ã€‚â¼€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ã€‚åŒâ¼€ä¸ªç¨‹åºä¸­çš„æ‰€æœ‰çº¿ç¨‹å‡ä¼šç‹¬â½´æ‰§â¾ç›¸åŒç¨‹åºï¼Œä¸”å…±äº«åŒâ¼€ä»½å…¨å±€å†…å­˜åŒºåŸŸã€‚</p>

<p>åŒâ¼€è¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹å¯ä»¥å¹¶å‘æ‰§â¾ã€‚åœ¨å¤šå¤„ç†å™¨ç¯å¢ƒä¸‹ï¼Œå¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶å¹¶â¾ã€‚å¦‚æœâ¼€ä¸ªçº¿ç¨‹å› ç­‰å¾…I/Oæ“ä½œâ½½é­é˜»å¡ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹ä¾ç„¶å¯ä»¥ç»§ç»­è¿â¾ã€‚</p>

<p>åœ¨Linuxä¸­ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒâ½¤clone()æ¥å®ç°çº¿ç¨‹çš„ã€‚ä»å‰â¾¯çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œè¯¥ç³»ç»Ÿè°ƒâ½¤ä¹Ÿå¯ä»¥â½¤æ¥åˆ›å»ºè¿›ç¨‹ã€‚å®é™…ä¸Šï¼Œä»å†…æ ¸çš„â»†åº¦æ¥è¯´ï¼Œå®ƒå¹¶æ²¡æœ‰çº¿ç¨‹è¿™ä¸ªæ¦‚å¿µã€‚LinuxæŠŠæ‰€æœ‰çš„çº¿ç¨‹éƒ½å½“ä½œè¿›ç¨‹æ¥å®ç°ã€‚å†…æ ¸å¹¶æ²¡æœ‰å‡†å¤‡ç‰¹åˆ«çš„è°ƒåº¦ç®—æ³•æˆ–æ˜¯å®šä¹‰ç‰¹åˆ«çš„æ•°æ®ç»“æ„æ¥è¡¨å¾çº¿ç¨‹ã€‚ç›¸åï¼Œçº¿ç¨‹ä»…ä»…è¢«è§†ä¸ºâ¼€ä¸ªä½¿â½¤æŸäº›å…±äº«èµ„æºçš„è¿›ç¨‹ã€‚æ‰€ä»¥ï¼Œåœ¨å†…æ ¸ä¸­ï¼Œå®ƒçœ‹èµ·æ¥å°±æ˜¯â¼€ä¸ªæ™®é€šçš„è¿›ç¨‹ï¼ˆåªæ˜¯è¯¥è¿›ç¨‹å’Œå…¶ä»–â¼€äº›è¿›ç¨‹å…±äº«æŸäº›èµ„æºï¼Œå¦‚åœ°å€ç©ºé—´ï¼‰</p>

<p>åœ¨Goä¸­ï¼Œé€šè¿‡clone()ç³»ç»Ÿè°ƒâ½¤æ¥åˆ›å»ºçº¿ç¨‹ï¼Œå…¶ä¸­çš„clone_flagsä¸º:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cloneFlags = _CLONE_VM | /* share memory */
        _CLONE_FS | /* share cwd, etc */
        _CLONE_FILES | /* share fd table */
        _CLONE_SIGHAND | /* share sig handler table */
        _CLONE_THREAD /* revisit - okay for now */
</code></pre></div></div>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œâ½—â¼¦ä¿©å…±äº«äº†åœ°å€ç©ºé—´(_CLONE_VM)ã€â½‚ä»¶ç³»ç»Ÿèµ„æº(_CLONE_FS)ã€â½‚ä»¶æè¿°ç¬¦(_CLONE_FILES)å’Œä¿¡å·å¤„ç†ç¨‹åº(_CLONE_SIGHAND)ã€‚â½½_CLONE_THREADåˆ™ä¼šå°†â½—â¼¦è¿›ç¨‹æ”¾â¼Šç›¸åŒçš„çº¿ç¨‹ç»„ã€‚è¿™æ ·â¼€æ¥ï¼Œæ–°å»ºçš„è¿›ç¨‹å’Œâ½—è¿›ç¨‹éƒ½å«åšçº¿ç¨‹</p>

<h4 id="è¿›ç¨‹é—´é€šä¿¡">è¿›ç¨‹é—´é€šä¿¡</h4>

<h5 id="ç±»å‹å®‰å…¨æ“ä½œ">â¾®ç±»å‹å®‰å…¨æ“ä½œ</h5>

<p>unsafeåº“å¾˜å¾Šåœ¨â€œç±»å‹å®‰å…¨â€è¾¹ç¼˜ï¼Œç”±äºå®ƒä»¬ç»•è¿‡äº†Golangçš„å†…å­˜å®‰å…¨åŸåˆ™ï¼Œâ¼€èˆ¬è¢«è®¤ä¸ºä½¿â½¤è¯¥åº“æ˜¯ä¸å®‰å…¨çš„ã€‚ä½†æ˜¯ï¼Œåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œunsafeåº“çš„ä½œâ½¤â¼œæ˜¯ä¸å¯æ›¿ä»£çš„ï¼Œçµæ´»åœ°ä½¿â½¤å®ƒä»¬å¯ä»¥å®ç°å¯¹å†…å­˜çš„ç›´æ¥è¯»å†™æ“ä½œã€‚åœ¨reflectåº“ã€syscallåº“ä»¥åŠå…¶ä»–è®¸å¤šéœ€è¦æ“ä½œå†…å­˜çš„å¼€æºé¡¹â½¬ä¸­éƒ½æœ‰å¯¹å®ƒçš„å¼•â½¤ã€‚</p>

<p>unsafeåº“æºç æå°‘ï¼Œåªæœ‰ä¸¤ä¸ªç±»å‹çš„å®šä¹‰å’Œä¸‰ä¸ªâ½…æ³•çš„å£°æ˜</p>

<h6 id="arbitrary-ç±»å‹">Arbitrary ç±»å‹</h6>

<p>å®˜â½…å¯¼å‡ºè¿™ä¸ªç±»å‹åªæ˜¯å‡ºäºå®Œå–„â½‚æ¡£çš„è€ƒè™‘ï¼Œåœ¨å…¶ä»–çš„åº“å’Œä»»ä½•é¡¹â½¬ä¸­éƒ½æ²¡æœ‰ä½¿â½¤ä»·å€¼ï¼Œé™¤â¾®ç¨‹åºå‘˜æ•…æ„ä½¿â½¤å®ƒ</p>

<h6 id="pointer-ç±»å‹">Pointer ç±»å‹</h6>

<p>è¿™ä¸ªç±»å‹â½è¾ƒé‡è¦ï¼Œå®ƒæ˜¯å®ç°å®šä½æ¬²è¯»å†™çš„å†…å­˜çš„åŸºç¡€ã€‚å®˜â½…â½‚æ¡£å¯¹è¯¥ç±»å‹æœ‰å››ä¸ªé‡è¦æè¿°</p>

<ul>
  <li>ä»»ä½•ç±»å‹çš„æŒ‡é’ˆéƒ½å¯ä»¥è¢«è½¬åŒ–ä¸ºPointer</li>
  <li>Pointerå¯ä»¥è¢«è½¬åŒ–ä¸ºä»»ä½•ç±»å‹çš„æŒ‡é’ˆ</li>
  <li>uintptrå¯ä»¥è¢«è½¬åŒ–ä¸ºPointer</li>
  <li>Pointerå¯ä»¥è¢«è½¬åŒ–ä¸ºuintptr</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func main() {
    i := 100
    fmt.Println(i) // 100
    p := (*int)unsafe.Pointer(&amp;i)
    fmt.Println(*p) // 100
    *p = 0
    fmt.Println(i) // 0
    fmt.Println(*p) // 0
}
</code></pre></div></div>
<h6 id="sizeof-å‡½æ•°">Sizeof å‡½æ•°</h6>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func Sizeof(v ArbitraryType) uintptr
</code></pre></div></div>

<p>Sizeofå‡½æ•°è¿”å›å˜é‡vå â½¤çš„å†…å­˜ç©ºé—´çš„å­—èŠ‚æ•°ï¼Œè¯¥å­—èŠ‚æ•°ä¸æ˜¯æŒ‰ç…§å˜é‡vå®é™…å â½¤çš„å†…å­˜è®¡ç®—ï¼Œâ½½æ˜¯æŒ‰ç…§vçš„â€œtoplevelâ€å†…å­˜è®¡ç®—ã€‚â½å¦‚ï¼Œåœ¨64ä½ç³»ç»Ÿä¸­ï¼Œå¦‚æœå˜é‡væ˜¯intç±»å‹ï¼Œä¼šè¿”å›16ï¼Œå› ä¸ºvçš„â€œtoplevelâ€å†…å­˜å°±æ˜¯å®ƒçš„å€¼ä½¿â½¤çš„å†…å­˜ï¼›å¦‚æœå˜é‡væ˜¯stringç±»å‹ï¼Œä¼šè¿”å›16ï¼Œå› ä¸ºvçš„â€œtoplevelâ€å†…å­˜ä¸æ˜¯å­˜æ”¾ç€å®é™…çš„å­—ç¬¦ä¸²ï¼Œâ½½æ˜¯è¯¥å­—ç¬¦ä¸²çš„åœ°å€ï¼›å¦‚æœå˜é‡væ˜¯sliceç±»å‹ï¼Œä¼šè¿”å›24ï¼Œè¿™æ˜¯å› ä¸ºsliceçš„æè¿°ç¬¦å°±å äº†24ä¸ªå­—èŠ‚</p>

<h6 id="offsetof-å‡½æ•°">Offsetof å‡½æ•°</h6>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func Offsetof(v ArbitraryType) uintptr
</code></pre></div></div>

<p>è¯¥å‡½æ•°è¿”å›ç”±væ‰€æŒ‡ç¤ºçš„æŸç»“æ„ä½“ä¸­çš„å­—æ®µåœ¨è¯¥ç»“æ„ä½“ä¸­çš„ä½ç½®åç§»å­—èŠ‚æ•°ï¼Œæ³¨æ„ï¼Œvçš„è¡¨è¾¾â½…å¼å¿…é¡»æ˜¯â€œstruct.filedâ€å½¢å¼ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="n">import</span> <span class="p">(</span>
	<span class="s2">"fmt"</span>
	<span class="s2">"unsafe"</span>
<span class="p">)</span>

<span class="n">type</span> <span class="n">Datas</span> <span class="n">struct</span> <span class="p">{</span>
	<span class="n">c0</span> <span class="n">byte</span>
	<span class="n">c1</span> <span class="n">int</span>
	<span class="n">c2</span> <span class="k">string</span>
	<span class="n">c3</span> <span class="n">int</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">var</span> <span class="n">d</span> <span class="n">Datas</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="n">unsafe</span><span class="p">.</span><span class="n">Offsetof</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">c0</span><span class="p">))</span> <span class="p">//</span> <span class="m">0</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="n">unsafe</span><span class="p">.</span><span class="n">Offsetof</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">c1</span><span class="p">))</span> <span class="p">//</span> <span class="m">8</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="n">unsafe</span><span class="p">.</span><span class="n">Offsetof</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">c2</span><span class="p">))</span> <span class="p">//</span> <span class="m">16</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="n">unsafe</span><span class="p">.</span><span class="n">Offsetof</span><span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">c3</span><span class="p">))</span> <span class="p">//</span> <span class="m">32</span>
<span class="p">}</span>

</code></pre></div></div>

<h6 id="alignof">Alignof</h6>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//è¿”å›ç»“æ„ä½“ä¸­æŸä¸ªfieldçš„å¯¹é½å€¼ï¼ˆå­—èŠ‚å¯¹é½çš„åŸå› ï¼‰
func Alignof(x ArbitraryType) uintptr
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="n">import</span> <span class="p">(</span>
	<span class="s2">"fmt"</span>
	<span class="s2">"unsafe"</span>
<span class="p">)</span>

<span class="n">type</span> <span class="n">Datas</span> <span class="n">struct</span> <span class="p">{</span>
	<span class="n">c0</span> <span class="n">byte</span>
	<span class="n">c1</span> <span class="n">int</span>
	<span class="n">c2</span> <span class="k">string</span>
	<span class="n">c3</span> <span class="n">int</span>
<span class="p">}</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">var</span> <span class="n">x</span> <span class="n">struct</span> <span class="p">{</span>
		<span class="n">a</span> <span class="n">bool</span>
		<span class="n">b</span> <span class="n">int16</span>
		<span class="n">c</span> <span class="p">[]</span><span class="n">int</span>
	<span class="p">}</span>

	<span class="p">/**</span>
	  <span class="n">unsafe</span><span class="p">.</span><span class="n">Offsetof</span> <span class="err">å‡½æ•°çš„å‚æ•°å¿…é¡»æ˜¯ä¸€ä¸ªå­—æ®µ</span> <span class="n">x</span><span class="p">.</span><span class="n">f</span><span class="p">,</span> <span class="err">ç„¶åè¿”å›</span> <span class="n">f</span> <span class="err">å­—æ®µç›¸å¯¹äº</span> <span class="n">x</span> <span class="err">èµ·å§‹åœ°å€çš„åç§»é‡</span><span class="p">,</span> <span class="err">åŒ…æ‹¬å¯èƒ½çš„ç©ºæ´</span><span class="p">.</span>
	<span class="p">*/</span>

	<span class="p">/**</span>
	  <span class="n">uintptr</span><span class="p">(</span><span class="n">unsafe</span><span class="p">.</span><span class="n">Pointer</span><span class="p">(&amp;</span><span class="n">x</span><span class="p">))</span> <span class="p">+</span> <span class="n">unsafe</span><span class="p">.</span><span class="n">Offsetof</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">b</span><span class="p">)</span>
	  <span class="err">æŒ‡é’ˆçš„è¿ç®—</span>
	<span class="p">*/</span>
	<span class="p">//</span> <span class="err">å’Œ</span> <span class="n">pb</span> <span class="p">:=</span> <span class="p">&amp;</span><span class="n">x</span><span class="p">.</span><span class="n">b</span> <span class="err">ç­‰ä»·</span>
	<span class="n">pb</span> <span class="p">:=</span> <span class="p">(*</span><span class="n">int16</span><span class="p">)(</span><span class="n">unsafe</span><span class="p">.</span><span class="n">Pointer</span><span class="p">(</span><span class="n">uintptr</span><span class="p">(</span><span class="n">unsafe</span><span class="p">.</span><span class="n">Pointer</span><span class="p">(&amp;</span><span class="n">x</span><span class="p">))</span> <span class="p">+</span> <span class="n">unsafe</span><span class="p">.</span><span class="n">Offsetof</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">b</span><span class="p">)))</span>
	<span class="p">*</span><span class="n">pb</span> <span class="p">=</span> <span class="m">42</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">b</span><span class="p">)</span> <span class="p">//</span> <span class="s2">"42"</span>
<span class="p">}</span>

</code></pre></div></div>

<h4 id="sync---å¤„ç†åŒæ­¥éœ€æ±‚">sync - å¤„ç†åŒæ­¥éœ€æ±‚</h4>

<p>golangæ˜¯â¼€â»”è¯­â¾”çº§åˆ«â½€æŒå¹¶å‘çš„ç¨‹åºè¯­â¾”ã€‚golangä¸­ä½¿â½¤goè¯­å¥æ¥å¼€å¯â¼€ä¸ªæ–°çš„åç¨‹ã€‚goroutineæ˜¯â¾®å¸¸è½»é‡çš„ï¼Œé™¤äº†ç»™å®ƒåˆ†é…æ ˆç©ºé—´ï¼Œå®ƒæ‰€å â½¤çš„å†…å­˜ç©ºé—´æ˜¯å¾®ä¹å…¶å¾®çš„ã€‚</p>

<p>ä½†å½“å¤šä¸ªgoroutineåŒæ—¶è¿›â¾å¤„ç†çš„æ—¶å€™ï¼Œå°±ä¼šé‡åˆ°â½å¦‚åŒæ—¶æŠ¢å â¼€ä¸ªèµ„æºï¼ŒæŸä¸ªgoroutineç­‰å¾…å¦â¼€ä¸ªgoroutineå¤„ç†å®ŒæŸâ¼€ä¸ªæ­¥éª¤ä¹‹åæ‰èƒ½ç»§ç»­çš„éœ€æ±‚ã€‚åœ¨golangçš„å®˜â½…â½‚æ¡£ä¸Šï¼Œä½œè€…æ˜ç¡®æŒ‡å‡ºï¼Œgolangå¹¶ä¸å¸Œæœ›ä¾é å…±äº«å†…å­˜çš„â½…å¼è¿›â¾è¿›ç¨‹çš„ååŒæ“ä½œã€‚â½½æ˜¯å¸Œæœ›é€šè¿‡ç®¡é“channelçš„â½…å¼è¿›â¾ã€‚å½“ç„¶ï¼Œgolangä¹Ÿæä¾›äº†å…±äº«å†…å­˜ï¼Œé”ï¼Œç­‰æœºåˆ¶è¿›â¾ååŒæ“ä½œçš„åŒ…ã€‚syncåŒ…å°±æ˜¯ä¸ºäº†è¿™ä¸ªâ½¬çš„â½½å‡ºç°çš„ã€‚</p>

<h5 id="é”">é”</h5>

<p>syncåŒ…ä¸­å®šä¹‰äº†Lockerç»“æ„æ¥ä»£è¡¨é”</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>type Locker interface {
    Lock()
    Unlock()
}
</code></pre></div></div>

<p>å¹¶ä¸”åˆ›é€ äº†ä¸¤ä¸ªç»“æ„æ¥å®ç°Lockeræ¥â¼ï¼šMutex å’Œ RWMutex</p>

<p>Mutexå°±æ˜¯äº’æ–¥é”ï¼Œäº’æ–¥é”ä»£è¡¨ç€å½“æ•°æ®è¢«åŠ é”äº†ä¹‹åï¼Œé™¤äº†åŠ é”çš„ç¨‹åºï¼Œå…¶ä»–ç¨‹åºä¸èƒ½å¯¹æ•°æ®è¿›â¾è¯»æ“ä½œå’Œå†™æ“ä½œã€‚è¿™ä¸ªå½“ç„¶èƒ½è§£å†³å¹¶å‘ç¨‹åºå¯¹èµ„æºçš„æ“ä½œã€‚ä½†æ˜¯ï¼Œæ•ˆç‡ä¸Šæ˜¯ä¸ªé—®é¢˜ã€‚å½“åŠ é”åï¼Œå…¶ä»–ç¨‹åºè¦è¯»å–æ“ä½œæ•°æ®ï¼Œå°±åªèƒ½è¿›â¾ç­‰å¾…äº†ã€‚</p>

<p>è¿™ä¸ªæ—¶å€™å°±éœ€è¦ä½¿â½¤è¯»å†™é”ã€‚è¯»å†™é”åˆ†ä¸ºè¯»é”å’Œå†™é”ï¼Œè¯»æ•°æ®çš„æ—¶å€™ä¸Šè¯»é”ï¼Œå†™æ•°æ®çš„æ—¶å€™ä¸Šå†™é”ã€‚æœ‰å†™é”çš„æ—¶å€™ï¼Œæ•°æ®ä¸å¯è¯»ä¸å¯å†™ã€‚æœ‰è¯»é”çš„æ—¶å€™ï¼Œæ•°æ®å¯è¯»ï¼Œä¸å¯å†™ã€‚äº’æ–¥é”å°±ä¸ä¸¾ä¾‹â¼¦ï¼Œè¯»å†™é”å¯ä»¥çœ‹ä¸‹â¾¯çš„ä¾‹â¼¦ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="n">import</span> <span class="p">(</span>
	<span class="s2">"sync"</span>
	<span class="s2">"time"</span>
<span class="p">)</span>

<span class="n">type</span> <span class="n">Human</span> <span class="n">struct</span> <span class="p">{</span>
	<span class="n">tes</span>  <span class="n">bool</span>
	<span class="n">sex</span>  <span class="n">bool</span>
	<span class="n">age</span>  <span class="n">uint8</span>
	<span class="k">min</span>  <span class="n">int</span>
	<span class="n">name</span> <span class="k">string</span>
<span class="p">}</span>

<span class="n">var</span> <span class="n">m</span> <span class="p">*</span><span class="n">sync</span><span class="p">.</span><span class="n">RWMutex</span>
<span class="n">var</span> <span class="n">val</span> <span class="p">=</span> <span class="m">0</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">m</span> <span class="p">=</span> <span class="n">new</span><span class="p">(</span><span class="n">sync</span><span class="p">.</span><span class="n">RWMutex</span><span class="p">)</span>
	<span class="n">go</span> <span class="nb">read</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
	<span class="n">go</span> <span class="nb">write</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
	<span class="n">go</span> <span class="nb">read</span><span class="p">(</span><span class="m">3</span><span class="p">)</span>
	<span class="n">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">5</span> <span class="p">*</span> <span class="n">time</span><span class="p">.</span><span class="n">Second</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">func</span> <span class="nb">read</span><span class="p">(</span><span class="n">i</span> <span class="n">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">m</span><span class="p">.</span><span class="n">RLock</span><span class="p">()</span>
	<span class="n">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">1</span> <span class="p">*</span> <span class="n">time</span><span class="p">.</span><span class="n">Second</span><span class="p">)</span>
	<span class="n">println</span><span class="p">(</span><span class="s2">"val"</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
	<span class="n">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">1</span> <span class="p">*</span> <span class="n">time</span><span class="p">.</span><span class="n">Second</span><span class="p">)</span>
	<span class="n">m</span><span class="p">.</span><span class="n">RUnlock</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">func</span> <span class="nb">write</span><span class="p">(</span><span class="n">i</span> <span class="n">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">m</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span>
	<span class="n">val</span> <span class="p">=</span> <span class="m">10</span>
	<span class="n">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">1</span> <span class="p">*</span> <span class="n">time</span><span class="p">.</span><span class="n">Second</span><span class="p">)</span>
	<span class="n">m</span><span class="p">.</span><span class="n">Unlock</span><span class="p">()</span>
<span class="p">}</span>


<span class="p">//</span> <span class="err">ä¸€èˆ¬æƒ…å†µä¸‹</span>

<span class="n">val</span> <span class="p">:</span> <span class="m">0</span>
<span class="n">val</span> <span class="p">:</span> <span class="m">10</span>
</code></pre></div></div>

<h6 id="å¯¹è±¡æ± ">å¯¹è±¡æ± </h6>

<p>å½“å¤šä¸ªgoroutineéƒ½éœ€è¦åˆ›å»ºåŒâ¼€ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œå¦‚æœgoroutineè¿‡å¤šï¼Œå¯èƒ½å¯¼è‡´å¯¹è±¡çš„åˆ›å»ºæ•°â½¬å‰§å¢ã€‚â½½å¯¹è±¡â¼œæ˜¯å â½¤å†…å­˜çš„ï¼Œè¿›â½½å¯¼è‡´çš„å°±æ˜¯å†…å­˜å›æ”¶çš„GCå‹â¼’å¾’å¢ã€‚é€ æˆâ€œå¹¶å‘â¼¤ï¼å â½¤å†…å­˜â¼¤ï¼GCç¼“æ…¢ï¼å¤„ç†å¹¶å‘èƒ½â¼’é™ä½ï¼å¹¶å‘æ›´â¼¤â€è¿™æ ·çš„æ¶æ€§å¾ªç¯ã€‚åœ¨è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬â¾®å¸¸è¿«åˆ‡éœ€è¦æœ‰â¼€ä¸ªå¯¹è±¡æ± ï¼Œæ¯ä¸ªgoroutineä¸å†â¾ƒâ¼°å•ç‹¬åˆ›å»ºå¯¹è±¡ï¼Œâ½½æ˜¯ä»å¯¹è±¡æ± ä¸­è·å–å‡ºâ¼€ä¸ªå¯¹è±¡ï¼ˆå¦‚æœæ± ä¸­å·²ç»æœ‰çš„è¯ï¼‰ã€‚è¿™å°±æ˜¯sync.Poolå‡ºç°çš„â½¬çš„äº†ã€‚</p>

<p>sync.Poolçš„ä½¿â½¤â¾®å¸¸ç®€å•ï¼Œæä¾›ä¸¤ä¸ªâ½…æ³•:Getå’ŒPutå’Œâ¼€ä¸ªåˆå§‹åŒ–å›è°ƒå‡½æ•°New</p>

<p>çœ‹ä¸‹â¾¯è¿™ä¸ªä¾‹â¼¦ï¼ˆå–â¾ƒgomemcacheï¼‰:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// keyBufPool returns []byte buffers for use by PickServer's call to
// crc32.ChecksumIEEE to avoid allocations. (but doesn't avoid the
// copies, which at least are bounded in size and small)
var keyBufPool = sync.Pool{
	New: func() interface{} {
		b := make([]byte, 256)
		return &amp;b
	},
}
func (ss *ServerList) PickServer(key string) (net.Addr, error) {
	ss.mu.RLock()
	defer ss.mu.RUnlock()
	if len(ss.addrs) == 0 {
		return nil, ErrNoServers
	}
	if len(ss.addrs) == 1 {
		return ss.addrs[0], nil
	}
	bufp := keyBufPool.Get().(*[]byte)
	n := copy(*bufp, key)
	cs := crc32.ChecksumIEEE((*bufp)[:n])
	keyBufPool.Put(bufp)
	return ss.addrs[cs%uint32(len(ss.addrs))], nil
}
</code></pre></div></div>

<h6 id="once---åªæ‰§è¡Œä¸€æ¬¡æ“ä½œ">Once - åªæ‰§è¡Œä¸€æ¬¡æ“ä½œ</h6>

<p>æ“ä½œåªå¸Œæœ›è¢«æ‰§â¾â¼€æ¬¡</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func main() {
	var once sync.Once
	onceBody := func() {
		fmt.Println("Only once")
	}
	for i := 0; i &lt; 10; i++ {
		go func() {
			once.Do(onceBody)
		}()
	}
	time.Sleep(3e9)
}


åªä¼šæ‰“å°ä¸€æ¬¡ Only once
</code></pre></div></div>

<h6 id="waitgroup-å’Œ-cond">WaitGroup å’Œ Cond</h6>

<p>â¼€ä¸ªgoroutineéœ€è¦ç­‰å¾…â¼€æ‰¹goroutineæ‰§â¾å®Œæ¯•ä»¥åæ‰ç»§ç»­æ‰§â¾ï¼Œé‚£ä¹ˆè¿™ç§å¤šçº¿ç¨‹ç­‰å¾…çš„é—®é¢˜å°±å¯ä»¥ä½¿â½¤WaitGroupäº†</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func main() {
    wp := new(sync.WaitGroup)
    wp.Add(10);
    for i := 0; i &lt; 10; i++ {
    go func() {
    fmt.Println("done ", i)
    wp.Done()
    }()
    }
    wp.Wait()
    fmt.Println("wait end")
}
</code></pre></div></div>

<p>è¿˜æœ‰ä¸ªsync.Condæ˜¯â½¤æ¥æ§åˆ¶æŸä¸ªæ¡ä»¶ä¸‹ï¼Œgoroutineè¿›â¼Šç­‰å¾…æ—¶æœŸï¼Œç­‰å¾…ä¿¡å·åˆ°æ¥,,ç„¶åé‡æ–°å¯åŠ¨</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func main() {
    locker := new(sync.Mutex)
    cond := sync.NewCond(locker)
    done := false
    cond.L.Lock()
    go func() {
    time.Sleep(2e9)
    done = true
    cond.Signal()
    }()
    if (!done) {
    cond.Wait()
    }
    fmt.Println("now done is ", done);
}

è¿™â¾¥å½“ä¸»goroutineè¿›â¼Šcond.Waitçš„æ—¶å€™ï¼Œå°±ä¼šè¿›â¼Šç­‰å¾…ï¼Œå½“ä»goroutineå‘å‡ºä¿¡å·ä¹‹åï¼Œä¸»goroutineæ‰ä¼šç»§ç»­å¾€ä¸‹â¾¯â¾›
</code></pre></div></div>

<p>sync.Condè¿˜æœ‰â¼€ä¸ªBroadCastâ½…æ³•ï¼Œâ½¤æ¥é€šçŸ¥å”¤é†’æ‰€æœ‰ç­‰å¾…çš„gouroutine</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="n">import</span> <span class="p">(</span>
	<span class="s2">"fmt"</span>
	<span class="s2">"sync"</span>
	<span class="s2">"time"</span>
<span class="p">)</span>

<span class="n">var</span> <span class="n">locker</span> <span class="p">=</span> <span class="n">new</span><span class="p">(</span><span class="n">sync</span><span class="p">.</span><span class="n">Mutex</span><span class="p">)</span>
<span class="n">var</span> <span class="n">cond</span> <span class="p">=</span> <span class="n">sync</span><span class="p">.</span><span class="n">NewCond</span><span class="p">(</span><span class="n">locker</span><span class="p">)</span>

<span class="n">func</span> <span class="n">test</span><span class="p">(</span><span class="n">x</span> <span class="n">int</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">cond</span><span class="p">.</span><span class="n">L</span><span class="p">.</span><span class="n">Lock</span><span class="p">()</span>
	<span class="n">cond</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span> <span class="p">//</span> <span class="err">ç­‰å¾…é€šçŸ¥</span> <span class="err">æš‚æ—¶é˜»å¡</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
	<span class="n">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">Second</span> <span class="p">*</span> <span class="m">1</span><span class="p">)</span>
	<span class="n">cond</span><span class="p">.</span><span class="n">L</span><span class="p">.</span><span class="n">Unlock</span><span class="p">()</span> <span class="p">//</span> <span class="err">é‡Šæ”¾é”ï¼Œä¸é‡Šæ”¾çš„è¯å°†åªä¼šæœ‰â¼€æ¬¡è¾“å‡º</span>
<span class="p">}</span>
<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">for</span> <span class="n">i</span> <span class="p">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">40</span><span class="p">;</span> <span class="n">i</span><span class="p">++</span> <span class="p">{</span>
		<span class="n">go</span> <span class="n">test</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">Println</span><span class="p">(</span><span class="s2">"start all"</span><span class="p">)</span>
	<span class="n">cond</span><span class="p">.</span><span class="n">Broadcast</span><span class="p">()</span> <span class="p">//</span> <span class="err">ä¸‹å‘â¼´æ’­ç»™æ‰€æœ‰ç­‰å¾…çš„</span><span class="n">goroutine</span>
	<span class="n">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">Second</span> <span class="p">*</span> <span class="m">60</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></div></div>

<p>ä¸»gouroutineå¼€å¯åï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ªä»gouroutineï¼Œä»gouroutineè·å–é”åï¼Œè¿›â¼Šcond.WaitçŠ¶æ€ï¼Œå½“ä¸»gouroutineæ‰§â¾å®Œä»»åŠ¡åï¼Œé€šè¿‡BroadCastâ¼´æ’­ä¿¡å·ã€‚å¤„äºcond.WaitçŠ¶æ€çš„æ‰€æœ‰gouroutineæ”¶åˆ°ä¿¡å·åå°†å…¨éƒ¨è¢«å”¤é†’å¹¶å¾€ä¸‹æ‰§â¾ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»gouroutineæ‰§â¾å®Œä»»åŠ¡åï¼Œéœ€è¦é€šè¿‡cond.L.Unlocké‡Šæ”¾é”ï¼Œå¦åˆ™å…¶å®ƒè¢«å”¤é†’çš„gouroutineå°†æ²¡æ³•ç»§ç»­æ‰§â¾ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func (c *Cond) Wait() {
    c.checker.check()
    if raceenabled {
        raceDisable()
    }
    atomic.AddUint32(&amp;c.waiters, 1)
    if raceenabled {
        raceEnable()
    }
    // é‡Šæ”¾
    c.L.Unlock()
    runtime_Syncsemacquire(&amp;c.sema)
    // é‡æ–°ä¸Šé”
    c.L.Lock()
}
</code></pre></div></div>

<p>Cond.Waitä¼šâ¾ƒåŠ¨é‡Šæ”¾é”ç­‰å¾…ä¿¡å·çš„åˆ°æ¥ï¼Œå½“ä¿¡å·åˆ°æ¥åï¼Œç¬¬â¼€ä¸ªè·å–åˆ°ä¿¡å·çš„Waitå°†ç»§ç»­å¾€ä¸‹æ‰§â¾å¹¶ä»æ–°ä¸Šé”ï¼Œå¦‚æœä¸é‡Šæ”¾é”ï¼Œå…¶å®ƒæ”¶åˆ°ä¿¡å·çš„gouroutineå°†é˜»å¡â½†æ³•ç»§ç»­æ‰§â¾ã€‚ç”±äºå„ä¸ªWaitæ”¶åˆ°ä¿¡å·çš„æ—¶é—´æ˜¯ä¸ç¡®å®šçš„ï¼Œå› æ­¤æ¯æ¬¡çš„è¾“å‡ºé¡ºåºä¹Ÿéƒ½æ˜¯éšæœºçš„</p>

<h4 id="syncatomic---åŸå­æ“ä½œ">sync/atomic - åŸå­æ“ä½œ</h4>

<p>å¯¹äºå¹¶å‘æ“ä½œâ½½â¾”ï¼ŒåŸâ¼¦æ“ä½œæ˜¯ä¸ªâ¾®å¸¸ç°å®çš„é—®é¢˜ã€‚å…¸å‹çš„å°±æ˜¯i++çš„é—®é¢˜ã€‚å½“ä¸¤ä¸ªCPUåŒæ—¶å¯¹å†…å­˜ä¸­çš„iè¿›â¾è¯»å–ï¼Œç„¶åæŠŠåŠ â¼€ä¹‹åçš„å€¼æ”¾â¼Šå†…å­˜ä¸­ï¼Œå¯èƒ½ä¸¤æ¬¡i++çš„ç»“æœï¼Œè¿™ä¸ªiåªå¢åŠ äº†â¼€æ¬¡ã€‚å¦‚ä½•ä¿è¯å¤šCPUå¯¹åŒâ¼€å—å†…å­˜çš„æ“ä½œæ˜¯åŸâ¼¦çš„ã€‚golangä¸­sync/atomicå°±æ˜¯åšè¿™ä¸ªä½¿â½¤çš„ã€‚</p>

<p>å…·ä½“çš„åŸâ¼¦æ“ä½œåœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸­å®ç°æ˜¯ä¸åŒçš„ã€‚â½å¦‚åœ¨Intelçš„CPUæ¶æ„æœºå™¨ä¸Šï¼Œä¸»è¦æ˜¯ä½¿â½¤æ€»çº¿é”çš„â½…å¼å®ç°çš„ã€‚â¼¤è‡´çš„æ„æ€å°±æ˜¯å½“â¼€ä¸ªCPUéœ€è¦æ“ä½œâ¼€ä¸ªå†…å­˜å—çš„æ—¶å€™ï¼Œå‘æ€»çº¿å‘é€â¼€ä¸ªLOCKä¿¡å·ï¼Œæ‰€æœ‰CPUæ”¶åˆ°è¿™ä¸ªä¿¡å·åå°±ä¸å¯¹è¿™ä¸ªå†…å­˜å—è¿›â¾æ“ä½œäº†ã€‚ç­‰å¾…æ“ä½œçš„CPUæ‰§â¾å®Œæ“ä½œåï¼Œå‘é€UNLOCKä¿¡å·ï¼Œæ‰ç»“æŸã€‚åœ¨AMDçš„CPUæ¶æ„æœºå™¨ä¸Šå°±æ˜¯ä½¿â½¤MESIâ¼€è‡´æ€§åè®®çš„â½…å¼æ¥ä¿è¯åŸâ¼¦æ“ä½œã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨çœ‹atomicæºç çš„æ—¶å€™ï¼Œæˆ‘ä»¬çœ‹åˆ°å®ƒé’ˆå¯¹ä¸åŒçš„æ“ä½œç³»ç»Ÿæœ‰ä¸åŒæ±‡ç¼–è¯­â¾”â½‚ä»¶ã€‚å¦‚æœæˆ‘ä»¬å–„â½¤åŸâ¼¦æ“ä½œï¼Œå®ƒä¼šâ½é”æ›´ä¸ºâ¾¼æ•ˆã€‚</p>

<h5 id="cas">CAS</h5>

<p>åŸâ¼¦æ“ä½œä¸­æœ€ç»å…¸çš„CAS(compare-and-swap)åœ¨atomicåŒ…ä¸­æ˜¯Compareå¼€å¤´çš„å‡½æ•°</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool)

func CompareAndSwapInt64(addr *int64, old, new int64) (swapped bool)

func CompareAndSwapPointer(addr *unsafe.Pointer, old, new unsafe.Pointer)
(swapped bool)

func CompareAndSwapUint32(addr *uint32, old, new uint32) (swapped bool)

func CompareAndSwapUint64(addr *uint64, old, new uint64) (swapped bool)

func CompareAndSwapUintptr(addr *uintptr, old, new uintptr) (swapped bool)
</code></pre></div></div>

<h6 id="å¢åŠ æˆ–å‡å°‘">å¢åŠ æˆ–å‡å°‘</h6>

<p>å¯¹â¼€ä¸ªæ•°å€¼è¿›â¾å¢åŠ æˆ–è€…å‡å°‘çš„â¾ä¸ºä¹Ÿéœ€è¦ä¿è¯æ˜¯åŸâ¼¦çš„ï¼Œå®ƒå¯¹åº”äºatomicåŒ…çš„å‡½æ•°å¦‚ä¸‹:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func AddInt32(addr *int32, delta int32) (new int32)

func AddInt64(addr *int64, delta int64) (new int64)

func AddUint32(addr *uint32, delta uint32) (new uint32)

func AddUint64(addr *uint64, delta uint64) (new uint64)

func AddUintptr(addr *uintptr, delta uintptr) (new uintptr)
</code></pre></div></div>

<h6 id="è¯»å–æˆ–å†™å…¥">è¯»å–æˆ–å†™å…¥</h6>

<p>å½“æˆ‘ä»¬è¦è¯»å–â¼€ä¸ªå˜é‡çš„æ—¶å€™ï¼Œå¾ˆæœ‰å¯èƒ½è¿™ä¸ªå˜é‡æ­£åœ¨è¢«å†™â¼Šï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¾ˆæœ‰å¯èƒ½è¯»å–åˆ°å†™åˆ°â¼€åŠçš„æ•°æ®ã€‚æ‰€ä»¥è¯»å–æ“ä½œæ˜¯éœ€è¦â¼€ä¸ªåŸâ¼¦â¾ä¸ºçš„ã€‚åœ¨atomicåŒ…ä¸­å°±æ˜¯Loadå¼€å¤´çš„å‡½æ•°ç¾¤</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func LoadInt32(addr *int32) (val int32)

func LoadInt64(addr *int64) (val int64)

func LoadPointer(addr *unsafe.Pointer) (val unsafe.Pointer)

func LoadUint32(addr *uint32) (val uint32)

func LoadUint64(addr *uint64) (val uint64)

func LoadUintptr(addr *uintptr) (val uintptr)
</code></pre></div></div>

<p>æ˜¯åŒæ ·çš„ï¼Œå¦‚æœæœ‰å¤šä¸ªCPUå¾€å†…å­˜ä¸­â¼€ä¸ªæ•°æ®å—å†™â¼Šæ•°æ®çš„æ—¶å€™ï¼Œå¯èƒ½å¯¼è‡´è¿™ä¸ªå†™â¼Šçš„æ•°æ®ä¸å®Œæ•´ã€‚åœ¨atomicåŒ…å¯¹åº”çš„æ˜¯Storeå¼€å¤´çš„å‡½æ•°ç¾¤ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func StoreInt32(addr *int32, val int32)

func StoreInt64(addr *int64, val int64)

func StorePointer(addr *unsafe.Pointer, val unsafe.Pointer)

func StoreUint32(addr *uint32, val uint32)

func StoreUint64(addr *uint64, val uint64)

func StoreUintptr(addr *uintptr, val uintpt
</code></pre></div></div>
:ET