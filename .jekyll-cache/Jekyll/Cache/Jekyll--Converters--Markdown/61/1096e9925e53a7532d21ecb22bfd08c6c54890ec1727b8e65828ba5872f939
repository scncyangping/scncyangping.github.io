I"‡<h4 id="æ¦‚è¿°">æ¦‚è¿°</h4>

<ul>
  <li>æºè‡ªä¸è°·æ­Œçš„MapReduceçš„è®ºæ–‡,å‘è¡¨äº2004å¹´12æœˆ</li>
  <li>Hadoop MapReduce æ˜¯ Google MapReduceçš„å…‹éš†ç‰ˆ</li>
  <li>MapReduceçš„æœ‰ç‚¹ : æµ·é‡æ•°æ®çš„ç¦»çº¿å¤„ç†&amp;æ˜“å¼€å‘&amp;æ˜“è¿è¡Œ</li>
  <li>MapReduceçš„ç¼ºç‚¹ : å®æ—¶æµå¼è®¡ç®—</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>input --&gt; spliting --&gt; Maping --&gt;

shuffling(å°†ä¸åŒçš„keyåˆ†åˆ°ä¸€èµ·) --&gt; Reduceing --&gt; Final result
</code></pre></div></div>

<h5 id="è¯»å–æµç¨‹">è¯»å–æµç¨‹</h5>

<ul>
  <li>InputFormat è¯»å–Hdfsé‡Œé¢çš„æ•°æ®</li>
  <li>è¯»å–çš„æ•°æ®è½¬ä¸ºSplit</li>
  <li>Splitè½¬ä¸ºRecordReader(ä¸€è¡Œæ•°æ®)</li>
  <li>Map</li>
  <li>Partitionï¼ˆShuffleï¼‰è¿‡ç¨‹</li>
  <li>Reduce</li>
</ul>

<h5 id="mapreduceç¼–ç¨‹æ¨¡å‹æ ¸å¿ƒæ¦‚å¿µ">MapReduceç¼–ç¨‹æ¨¡å‹æ ¸å¿ƒæ¦‚å¿µ</h5>
<ul>
  <li>Split
    <ol>
      <li>å°†è¾“å…¥çš„æ•°æ®è¿›è¡Œæ‹†åˆ†,æ‹†åˆ†ä¸ºRecordReader(ä¸€è¡Œæ•°æ®)</li>
    </ol>
  </li>
  <li>InputFormat
    <ol>
      <li>å°†RecordReaderè¿›è¡Œè¯»å–,å¤„ç†</li>
    </ol>
  </li>
  <li>OutPutFormat
    <ol>
      <li>å°†å¤„ç†äº†çš„æ•°æ®å†™å‡ºåˆ°æŒ‡å®šåœ°æ–¹</li>
    </ol>
  </li>
  <li>Combiner
    <ol>
      <li>è®¾ç½®Combiner: job.setComnierClass()</li>
      <li>åœ¨mapç«¯åšä¸€ä¸ªèšåˆ,åå†å°†æ•°æ®ä¼ åˆ°Reduce,è¿™ä¸ªæ“ä½œå…¶å®å’ŒReduceçš„é€»è¾‘æ˜¯ä¸€æ ·çš„</li>
      <li>ç®—é™¤æ³•çš„æ—¶å€™,æ¯”å¦‚å¹³å‡æ•°çš„æ—¶å€™,å…ˆèšåˆçš„è¯ä¼šå¯¼è‡´åˆ†æ¯å‡ºé—®é¢˜,éœ€è¦æ…é‡è€ƒè™‘</li>
    </ol>
  </li>
  <li>Partitioner  â€“&gt;æŒ‰keyåˆ†å‘mapåçš„å€¼</li>
</ul>

<h4 id="ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹è¿›è¡Œmapreduce">ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹è¿›è¡ŒMapReduce</h4>

<h5 id="è‡ªå®šä¹‰hadoopç±»å‹å¤„ç†ç±»">è‡ªå®šä¹‰Hadoopç±»å‹å¤„ç†ç±»</h5>
<ul>
  <li>å®ç°Writableæ¥å£</li>
  <li>å®šä¹‰ç©ºæ„é€ å‡½æ•°</li>
  <li>å¤å†™writeã€readFieldsæ–¹æ³•
    <ol>
      <li>write: å°†å„ä¸ªå­—æ®µå†™å…¥è¿›å» out.writeUTF(phone) â€¦.</li>
      <li>readFields: å°†å­—æ®µçš„å€¼è¯»å–å‡ºæ¥ in.readUTF()â€¦.</li>
      <li>è¯»å–å­—æ®µçš„å€¼çš„é¡ºåºå¿…é¡»å’Œå†™å…¥å­—æ®µçš„é¡ºåºç›¸åŒ</li>
    </ol>
  </li>
</ul>

<h5 id="è‡ªå®šä¹‰mapper">è‡ªå®šä¹‰Mapper</h5>

<ol>
  <li>å®šä¹‰ä½¿ç”¨</li>
  <li>å¤å†™mapæ–¹æ³•,åˆ†å‰²æ•°æ®,è¿›è¡Œæ•´ç†</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class AccessMapper extends
        Mapper&lt;LongWritable, Text,Text,Access&gt; {

    @Override
    protected void map(LongWritable key, Text value, Context context) throws IOException, InterruptedException {
        String[] lines =
                value.toString().split("\\s+");

        String phone = lines[1];// å–å‡ºæ‰‹æœºå·
        long up = Long.parseLong(lines[lines.length-3]);// å–å‡ºä¸Šè¡Œæµé‡
        long down = Long.parseLong(lines[lines.length-2]);// å–å‡ºä¸‹è¡Œæµé‡

        context.write(
                new Text(phone),
                new Access(phone,up,down));
    }
}
</code></pre></div></div>

<h5 id="è‡ªå®šä¹‰reducer">è‡ªå®šä¹‰Reducer</h5>

<ol>
  <li>ç»§æ‰¿Reducer</li>
  <li>å¤å†™Reduceæ–¹æ³•</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class AccessReducer extends
        Reducer&lt;Text,Access,Text,Access&gt; {

    @Override
    protected void reduce(Text key, Iterable&lt;Access&gt; values, Context context) throws IOException, InterruptedException {
        long ups = 0;
        long downs = 0;

        for(Access access : values){
            ups += access.getUp();
            downs += access.getDown();
        }

        context.write(key,
                new Access(key.toString(),ups,downs));
    }
}

//è‹¥ä¸æƒ³å†è¾“å‡ºkey,åªæƒ³è¾“å‡ºAccessçš„ä¿¡æ¯

public class AccessReducer extends
        Reducer&lt;Text,Access, NullWritable,Access&gt; {
            ...

            context.write(
                NullWritable.get(),
                new Access(key.toString(),ups,downs));
        }

</code></pre></div></div>

<h5 id="é»˜è®¤shuffleè§„åˆ™">é»˜è®¤shuffleè§„åˆ™</h5>

<p>HashPartitioner æ˜¯é»˜è®¤çš„åˆ†åŒºæ–¹å¼
è§„åˆ™ : åˆ†å‘çš„keyçš„hashå€¼ä¸reduce taskçš„ä¸ªæ•°å–æ¨¡</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class HashPartitioner&lt;K, V&gt; extends Partitioner&lt;K, V&gt; {
    public HashPartitioner() {
    }
    // numReduceTasks : æŒ‡å®šçš„Reducerçš„ä¸ªæ•°,å†³å®šäº†reduceä½œä¸šè¾“å‡ºæ–‡ä»¶çš„ä¸ªæ•°
    public int getPartition(K key, V value, int numReduceTasks) {
        return (key.hashCode() &amp; 2147483647) % numReduceTasks;
    }
}
</code></pre></div></div>

<h5 id="è‡ªå®šä¹‰åˆ†åŒºè§„åˆ™">è‡ªå®šä¹‰åˆ†åŒºè§„åˆ™</h5>

<ol>
  <li>ç»§æ‰¿Partitionerä¸¤ä¸ªèŒƒå‹ä¸ºmapè¾“å‡ºçš„keyå’Œvalueå€¼</li>
  <li>å¤å†™getPartitionæ–¹æ³•</li>
  <li>Jobä¸­è®¾ç½®Partitionå’Œåˆ†åŒºæ•°é‡</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class AccessPartitioner extends
        Partitioner&lt;Text,Access&gt; {

    @Override
    public int getPartition(Text phone, Access access, int i) {
        // å°†15å¼€å¤´çš„æ•°æ®,æ”¾åœ¨ç¬¬0ä¸ª
        if(phone.toString().startsWith("15")){
            return 0;
        }else if (phone.toString().startsWith("17")){
            return 1;
        }else{
            return 2;
        }
    }
}

//JOB
// è®¾ç½®è‡ªå®šä¹‰åˆ†åŒºè§„åˆ™
job.setPartitionerClass(AccessPartitioner.class);
// è®¾ç½®åˆ†åŒºä¸ªæ•°
job.setNumReduceTasks(3);


</code></pre></div></div>

<h5 id="å¯åŠ¨">å¯åŠ¨</h5>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static void main(String args[])throws Exception{
        Configuration configuration = new Configuration();

        // è®¾ç½®å‚æ•° å¯åœ¨æ­¤æŒ‡å®šè°ƒç”¨è¿œç¨‹hdfsæ–‡ä»¶ç³»ç»Ÿ
        Job job = Job.getInstance(configuration);

        // è®¾ç½®å¯åŠ¨ç±»åç§°
        job.setJarByClass(AccessApp.class);
        // è®¾ç½®è‡ªå®šä¹‰mapç±»
        job.setMapperClass(AccessMapper.class);
        // è®¾ç½®è‡ªå®šä¹‰reduceç±»
        job.setReducerClass(AccessReducer.class);

        // è®¾ç½®mapè¾“å‡ºçš„key,è¾“å…¥çš„keyé»˜è®¤ä¸ºLongWritable(è¡¨ç¤ºè¡Œå·)
        job.setMapOutputKeyClass(Text.class);
        // è®¾ç½®mapè¾“å‡ºçš„value, è¾“å…¥çš„valueé»˜è®¤ä¸ºé‚£ä¸€è¡Œæ•°æ®
        job.setMapOutputValueClass(Access.class);

        // è®¾ç½®reduceè¾“å‡ºçš„keyçš„ç±»å‹
        job.setOutputKeyClass(Text.class);
        // è®¾ç½®reduceè¾“å‡ºçš„valueçš„ç±»å‹
        job.setOutputValueClass(Access.class);


        // è®¾ç½®è‡ªå®šä¹‰åˆ†åŒºè§„åˆ™
        job.setPartitionerClass(AccessPartitioner.class);
        // è®¾ç½®åˆ†åŒºä¸ªæ•°
        job.setNumReduceTasks(3);

        // è®¾ç½®è¾“å…¥æ–‡ä»¶è·¯å¾„
        FileInputFormat.setInputPaths(
                job,
                new Path("access/input")
        );

        // è¾“å‡ºæ–‡ä»¶è·¯å¾„
        FileOutputFormat.setOutputPath(
                job,
                new Path("access/output")
        );
        job.waitForCompletion(true);

    }
</code></pre></div></div>
:ET